# 微信小程序登录接口说明

## 概述
本文档描述了微信小程序登录的完整流程，包括分步骤登录和用户信息完善功能。

## 接口列表

### 1. 微信小程序分步骤登录
**接口地址：** `POST /wxStepLogin`

**功能说明：** 根据微信code获取openId，检查用户是否存在及是否已绑定手机号

**请求参数：**
```json
{
  "code": "微信登录code",
  "encryptedData": "用户信息加密数据（可选）",
  "iv": "用户信息加密向量（可选）",
  "rawData": "用户信息原始数据（可选）",
  "signature": "用户信息签名（可选）",
  "phoneEncryptedData": "手机号加密数据（可选）",
  "phoneIv": "手机号加密向量（可选）",
  "hasPhoneInfo": false
}
```

**响应结果：**
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "loginStatus": 0,  // 0: 需要获取手机号, 1: 登录成功, 2: 需要完善信息
    "message": "新用户需要获取手机号",
    "openId": "微信openId",
    "hasPhone": false,
    "userInfo": null,
    "token": null
  }
}
```

### 2. 微信小程序完善用户信息并登录
**接口地址：** `POST /wxCompleteUserInfo`

**功能说明：** 获取微信用户信息（昵称、头像、性别）和手机号，创建或更新用户并登录

**请求参数：**
```json
{
  "code": "微信登录code",
  "encryptedData": "用户信息加密数据",
  "iv": "用户信息加密向量",
  "rawData": "用户信息原始数据",
  "signature": "用户信息签名",
  "phoneEncryptedData": "手机号加密数据",
  "phoneIv": "手机号加密向量"
}
```

**响应结果：**
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "token": "登录令牌"
  }
}
```

### 3. 微信小程序一键登录（兼容旧版本）
**接口地址：** `POST /wxLogin`

**功能说明：** 一次性获取所有信息并完成登录（包含微信昵称、头像、性别和手机号）

**请求参数：**
```json
{
  "code": "微信登录code",
  "encryptedData": "用户信息加密数据",
  "iv": "用户信息加密向量",
  "rawData": "用户信息原始数据",
  "signature": "用户信息签名",
  "phoneEncryptedData": "手机号加密数据",
  "phoneIv": "手机号加密向量"
}
```

**响应结果：**
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "token": "登录令牌"
  }
}
```

## 用户信息存储

### 微信用户信息字段映射
系统会自动将微信用户信息存储到 `sys_user` 表的对应字段：

| 微信字段 | 数据库字段 | 说明 |
|---------|-----------|------|
| nickName | nick_name | 用户昵称 |
| avatarUrl | avatar | 头像地址 |
| gender | sex | 性别（0未知 1男 2女） |
| openid | open_id | 微信openId |
| unionid | union_id | 微信unionId |
| phoneNumber | phonenumber | 手机号码 |

### 昵称处理逻辑
- 如果微信昵称为空，系统会自动生成随机昵称（格式：微信用户+4位随机字符）
- 如果微信昵称不为空，直接使用微信昵称
- 所有昵称都会进行XSS过滤，确保安全性

### 头像处理逻辑
- 直接存储微信返回的头像URL地址
- 如果微信头像为空，则存储空字符串

### 用户信息自动补充功能
系统在每次微信登录时都会检查用户的昵称和头像字段是否为空：

1. **自动检测**：在用户登录时，系统会检查 `nick_name`、`avatar`、`sex` 字段是否为空
2. **智能补充**：如果发现字段为空且本次请求包含微信用户信息，系统会自动解密并补充这些信息
3. **增量更新**：只更新为空的字段，不会覆盖已有的用户信息
4. **日志记录**：所有补充操作都会记录详细日志，便于追踪

**补充逻辑示例：**
```java
// 检查用户信息是否完整
if (StringUtils.isEmpty(user.getNickName()) || StringUtils.isEmpty(user.getAvatar())) {
    // 尝试获取微信信息并补充
    supplementUserInfo(user, sessionKey, wxLoginBody, unionId);
}
```

**优势：**
- 确保用户信息的完整性
- 减少用户手动完善信息的步骤
- 提高用户体验
- 保持数据的一致性

## 登录流程

### 新用户首次登录流程
1. 调用 `/wxStepLogin` 获取openId
2. 系统检测到新用户，返回需要获取手机号状态（loginStatus=0）
3. 前端获取用户授权（昵称、头像、手机号）
4. 调用 `/wxCompleteUserInfo` 完善用户信息并登录
5. 系统创建新用户记录，存储微信昵称、头像等信息
6. 返回登录令牌

### 现有用户登录流程
1. 调用 `/wxStepLogin` 获取openId
2. 系统检测到现有用户
3. 如果用户已绑定手机号且信息完整，直接返回登录成功（loginStatus=1）
4. 如果用户已绑定手机号但信息不完整，返回需要完善用户信息（loginStatus=2）
5. 如果用户未绑定手机号，返回需要获取手机号状态（loginStatus=0）
6. 前端根据状态进行相应操作：
   - loginStatus=0：获取手机号授权
   - loginStatus=2：获取用户信息授权
7. 调用 `/wxCompleteUserInfo` 更新信息并登录

### 用户信息补充流程
1. 用户登录时，系统检查昵称和头像是否为空
2. 如果为空且本次请求包含微信用户信息，自动补充
3. 如果为空但未提供微信用户信息，返回状态2要求完善信息
4. 前端获取用户信息后重新调用登录接口

## 错误处理

### 常见错误码
- `手机号获取失败，请重新授权` - 手机号解密失败
- `微信用户信息签名校验失败` - 用户信息签名验证失败
- `小程序登录失败` - 其他登录相关错误

### 异常处理
- 微信用户信息解密失败时，会使用默认值（昵称：微信用户，头像：空，性别：0）
- 手机号解密失败时，会抛出异常，要求用户重新授权
- 所有异常都会记录详细日志，便于问题排查

## 安全考虑

1. **数据验证**：所有用户输入都进行XSS过滤
2. **签名校验**：微信用户信息必须通过签名校验
3. **异常处理**：完善的异常处理机制，避免敏感信息泄露
4. **日志记录**：详细的操作日志，便于安全审计

## 注意事项

1. 微信昵称和头像会在每次登录时更新，确保用户信息的最新性
2. 手机号是必需字段，没有手机号的用户无法完成登录
3. 系统会自动处理微信昵称为空的情况，生成友好的随机昵称
4. 所有微信相关字段都支持为空，确保系统的健壮性

## 测试验证

### 用户信息补充功能测试

#### 测试场景1：新用户首次登录
1. 创建新用户，只设置手机号，昵称和头像为空
2. 使用微信登录，提供用户信息
3. 验证系统是否自动补充昵称和头像

#### 测试场景2：现有用户信息不完整
1. 查询现有用户，确认昵称或头像为空
2. 使用微信登录，提供用户信息
3. 验证系统是否只补充空字段，不覆盖已有信息

#### 测试场景3：用户信息已完整
1. 查询现有用户，确认昵称、头像、性别都已完整
2. 使用微信登录，提供用户信息
3. 验证系统不会重复更新已有信息

### 验证SQL查询
```sql
-- 查看用户信息是否完整
SELECT user_id, nick_name, avatar, sex, open_id, phonenumber 
FROM sys_user 
WHERE open_id IS NOT NULL;

-- 查看信息不完整的用户
SELECT user_id, nick_name, avatar, sex, open_id, phonenumber 
FROM sys_user 
WHERE open_id IS NOT NULL 
AND (nick_name IS NULL OR nick_name = '' OR avatar IS NULL OR avatar = '');
```

### 日志验证
在应用日志中查找以下关键词来验证功能：
- `"用户昵称或头像为空，尝试获取微信信息并更新"`
- `"补充用户昵称"`
- `"补充用户头像"`
- `"补充用户性别"`
- `"成功补充用户微信信息"`

## 优势

1. **成本优化**：减少不必要的微信接口调用，降低API费用
2. **用户体验**：智能的登录流程，减少用户操作步骤
3. **数据完整性**：自动补充用户信息，确保数据质量
4. **系统健壮性**：完善的异常处理，提高系统稳定性
5. **可维护性**：清晰的代码结构和详细的日志记录

## 测试建议

1. 测试新用户首次登录流程
2. 测试已绑定手机号用户登录流程
3. 测试未绑定手机号用户登录流程
4. 测试各种异常情况的处理
5. 测试网络异常的重试机制 

### 登录状态说明

| 状态值 | 说明 | 下一步操作 |
|--------|------|------------|
| 0 | 需要获取手机号 | 调用 wx.getPhoneNumber() |
| 1 | 登录成功 | 保存token，进入应用 |
| 2 | 需要完善用户信息 | 调用 wx.getUserInfo() 获取昵称和头像 | 

## 前端处理示例

### 小程序端登录流程处理

```javascript
// 微信小程序登录处理
async handleWxLogin() {
  try {
    // 步骤1：获取微信登录code
    const loginResult = await this.wxLogin();
    
    // 步骤2：调用后端分步骤登录接口
    const response = await this.callWxStepLogin({
      code: loginResult.code
    });
    
    const result = response.data;
    
    // 步骤3：根据登录状态处理
    switch (result.loginStatus) {
      case 0:
        // 需要获取手机号
        await this.handleNeedPhone(result.openId);
        break;
      case 1:
        // 登录成功
        this.loginSuccess(result.token);
        break;
      case 2:
        // 需要完善用户信息
        await this.handleNeedUserInfo(result.openId);
        break;
      default:
        console.error('未知的登录状态:', result.loginStatus);
    }
  } catch (error) {
    console.error('微信登录失败:', error);
    uni.showToast({
      title: '登录失败，请重试',
      icon: 'none'
    });
  }
}

// 处理需要获取手机号的情况
async handleNeedPhone(openId) {
  try {
    // 获取用户信息
    const userInfo = await this.getUserProfile();
    
    // 获取手机号
    const phoneResult = await this.wxGetPhoneNumber();
    
    // 重新获取code
    const loginResult = await this.wxLogin();
    
    // 调用完善用户信息接口
    const response = await this.callWxCompleteUserInfo({
      code: loginResult.code,
      encryptedData: userInfo.encryptedData,
      iv: userInfo.iv,
      rawData: userInfo.rawData,
      signature: userInfo.signature,
      phoneEncryptedData: phoneResult.encryptedData,
      phoneIv: phoneResult.iv
    });
    
    this.loginSuccess(response.data.token);
  } catch (error) {
    console.error('获取手机号失败:', error);
    uni.showToast({
      title: '获取手机号失败，请重试',
      icon: 'none'
    });
  }
}

// 处理需要完善用户信息的情况
async handleNeedUserInfo(openId) {
  try {
    // 获取用户信息
    const userInfo = await this.getUserProfile();
    
    // 重新获取code
    const loginResult = await this.wxLogin();
    
    // 调用完善用户信息接口
    const response = await this.callWxCompleteUserInfo({
      code: loginResult.code,
      encryptedData: userInfo.encryptedData,
      iv: userInfo.iv,
      rawData: userInfo.rawData,
      signature: userInfo.signature
    });
    
    this.loginSuccess(response.data.token);
  } catch (error) {
    console.error('完善用户信息失败:', error);
    uni.showToast({
      title: '完善用户信息失败，请重试',
      icon: 'none'
    });
  }
}

// 获取用户信息
getUserProfile() {
  return new Promise((resolve, reject) => {
    uni.getUserProfile({
      desc: '用于完善用户资料',
      success: resolve,
      fail: reject
    });
  });
}

// 获取手机号
wxGetPhoneNumber() {
  return new Promise((resolve, reject) => {
    uni.getPhoneNumber({
      success: resolve,
      fail: reject
    });
  });
}

// 微信登录
wxLogin() {
  return new Promise((resolve, reject) => {
    uni.login({
      success: resolve,
      fail: reject
    });
  });
}
```

### 状态处理说明

1. **loginStatus=0（需要获取手机号）**
   - 新用户首次登录
   - 现有用户未绑定手机号
   - 需要同时获取用户信息和手机号

2. **loginStatus=1（登录成功）**
   - 用户信息完整，直接登录
   - 保存token，进入应用

3. **loginStatus=2（需要完善用户信息）**
   - 用户已绑定手机号但昵称或头像为空
   - 只需要获取用户信息，不需要手机号
   - 系统会自动补充缺失的信息 