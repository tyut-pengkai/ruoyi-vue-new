<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.xkt.mapper.StoreProductStockMapper">

    <select id="selectAppStockPage" parameterType="com.ruoyi.xkt.dto.storeProductStock.StoreProdStockPageDTO"
            resultType="com.ruoyi.xkt.dto.storeProductStock.StoreProdStockAppPageResDTO">
        SELECT
            sps.id AS storeProdStockId,
            sps.store_prod_id,
            sps.prod_art_num,
            sps.color_name,
            NULLIF( sps.size_30, 0 ) AS size30,
            NULLIF( sps.size_31, 0 ) AS size31,
            NULLIF( sps.size_32, 0 ) AS size32,
            NULLIF( sps.size_33, 0 ) AS size33,
            NULLIF( sps.size_34, 0 ) AS size34,
            NULLIF( sps.size_35, 0 ) AS size35,
            NULLIF( sps.size_36, 0 ) AS size36,
            NULLIF( sps.size_37, 0 ) AS size37,
            NULLIF( sps.size_38, 0 ) AS size38,
            NULLIF( sps.size_39, 0 ) AS size39,
            NULLIF( sps.size_40, 0 ) AS size40,
            NULLIF( sps.size_41, 0 ) AS size41,
            NULLIF( sps.size_42, 0 ) AS size42,
            NULLIF( sps.size_43, 0 ) AS size43,
            (IFNULL(sps.size_30, 0) + IFNULL(sps.size_31, 0) + IFNULL(sps.size_32, 0) + IFNULL(sps.size_33, 0) +
            IFNULL(sps.size_34, 0) + IFNULL(sps.size_35, 0) + IFNULL(sps.size_36, 0) + IFNULL(sps.size_37, 0) +
            IFNULL(sps.size_38, 0) + IFNULL(sps.size_39, 0) + IFNULL(sps.size_40, 0) + IFNULL(sps.size_41, 0) +
            IFNULL(sps.size_42, 0) + IFNULL(sps.size_43, 0)) AS totalStock
        FROM
            store_product_stock sps join store_product sp on sps.store_prod_id = sp.id join sys_product_category spc on sp.prod_cate_id = spc.id
        WHERE
            sps.del_flag = 0
            <if test="prodArtNum != null  and prodArtNum != ''"> and sps.prod_art_num like concat('%', #{prodArtNum}, '%')</if>
        ORDER BY
            sps.store_prod_id,
            sps.store_color_id
    </select>

    <select id="selectStockPage" parameterType="com.ruoyi.xkt.dto.storeProductStock.StoreProdStockPageDTO"
            resultType="com.ruoyi.xkt.dto.storeProductStock.StoreProdStockPageResDTO">
        SELECT
            sps.id AS storeProdStockId, sps.store_prod_id,  sps.prod_art_num, sps.store_color_id, sps.store_prod_color_id, sps.color_name, spc.name AS prodCateName,
            NULLIF(sps.size_30, 0) AS size30,  NULLIF(sps.size_31, 0) AS size31,  NULLIF(sps.size_32, 0) AS size32, NULLIF(sps.size_33, 0) AS size33,
            NULLIF(sps.size_34, 0) AS size34, NULLIF(sps.size_35, 0) AS size35, NULLIF(sps.size_36, 0) AS size36, NULLIF(sps.size_37, 0) AS size37,
            NULLIF(sps.size_38, 0) AS size38, NULLIF(sps.size_39, 0) AS size39, NULLIF(sps.size_40, 0) AS size40, NULLIF(sps.size_41, 0) AS size41,
            NULLIF(sps.size_42, 0) AS size42, NULLIF(sps.size_43, 0) AS size43,
            (IFNULL(sps.size_30, 0) + IFNULL(sps.size_31, 0) + IFNULL(sps.size_32, 0) + IFNULL(sps.size_33, 0) +
            IFNULL(sps.size_34, 0) + IFNULL(sps.size_35, 0) + IFNULL(sps.size_36, 0) + IFNULL(sps.size_37, 0) +
            IFNULL(sps.size_38, 0) + IFNULL(sps.size_39, 0) + IFNULL(sps.size_40, 0) + IFNULL(sps.size_41, 0) +
            IFNULL(sps.size_42, 0) + IFNULL(sps.size_43, 0)) AS totalStock
        FROM
            store_product_stock sps join store_product sp on sps.store_prod_id = sp.id join sys_product_category spc on sp.prod_cate_id = spc.id
        WHERE
            sps.del_flag = 0
            AND sps.store_id = #{storeId}
            <if test="prodArtNum != null  and prodArtNum != ''"> and sps.prod_art_num like concat('%', #{prodArtNum}, '%')</if>
        ORDER BY
            sps.store_prod_id,
            sps.store_color_id
    </select>

    <select id="selectTop10List" resultType="com.ruoyi.xkt.dto.dailyStoreTag.DailyStoreTagDTO">
        SELECT
            sps.store_id,
            SUM(
                IFNULL(size_30, 0) +
                IFNULL(size_31, 0) +
                IFNULL(size_32, 0) +
                IFNULL(size_33, 0) +
                IFNULL(size_34, 0) +
                IFNULL(size_35, 0) +
                IFNULL(size_36, 0) +
                IFNULL(size_37, 0) +
                IFNULL(size_38, 0) +
                IFNULL(size_39, 0) +
                IFNULL(size_40, 0) +
                IFNULL(size_41, 0) +
                IFNULL(size_42, 0) +
                IFNULL(size_43, 0)
                ) AS count
        FROM
            store_product_stock sps
        WHERE
            sps.del_flag = 0
            AND sps.create_time &gt;= #{oneMonthAgo}
            AND sps.create_time &lt;= #{yesterday}
        GROUP BY
            sps.store_id
        ORDER BY
            count DESC
            LIMIT 10
    </select>

    <select id="selectExportList" resultType="com.ruoyi.xkt.dto.storeProductStock.StoreProdStockDownloadDTO">
        SELECT
            sps.prod_art_num,
            sps.color_name,
            NULLIF(sps.size_30, 0) AS size30Quantity,
            NULLIF(sps.size_31, 0) AS size31Quantity,
            NULLIF(sps.size_32, 0) AS size32Quantity,
            NULLIF(sps.size_33, 0) AS size33Quantity,
            NULLIF(sps.size_34, 0) AS size34Quantity,
            NULLIF(sps.size_35, 0) AS size35Quantity,
            NULLIF(sps.size_36, 0) AS size36Quantity,
            NULLIF(sps.size_37, 0) AS size37Quantity,
            NULLIF(sps.size_38, 0) AS size38Quantity,
            NULLIF(sps.size_39, 0) AS size39Quantity,
            NULLIF(sps.size_40, 0) AS size40Quantity,
            NULLIF(sps.size_41, 0) AS size41Quantity,
            NULLIF(sps.size_42, 0) AS size42Quantity,
            NULLIF(sps.size_43, 0) AS size43Quantity,
            COALESCE ( sps.size_30, 0 ) + COALESCE ( sps.size_31, 0 ) + COALESCE ( sps.size_32, 0 ) + COALESCE ( sps.size_33, 0 ) + COALESCE ( sps.size_34, 0 ) +
            COALESCE ( sps.size_35, 0 ) + COALESCE ( sps.size_36, 0 ) + COALESCE ( sps.size_37, 0 ) + COALESCE ( sps.size_38, 0 ) + COALESCE ( sps.size_39, 0 ) +
            COALESCE ( sps.size_40, 0 ) + COALESCE ( sps.size_41, 0 ) + COALESCE ( sps.size_42, 0 ) + COALESCE ( sps.size_43, 0 ) AS totalQuantity
        FROM
            store_product_stock sps
        WHERE
            sps.del_flag = 0
            AND sps.id  IN
            <foreach collection="storeProdStockIdList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        ORDER BY
            sps.store_prod_id,
            sps.store_color_id
    </select>

    <select id="selectAllStockList" resultType="com.ruoyi.xkt.dto.storeProductStock.StoreProdStockDownloadDTO">
        SELECT
            sps.prod_art_num,
            sps.color_name,
            NULLIF(sps.size_30, 0) AS size30Quantity,
            NULLIF(sps.size_31, 0) AS size31Quantity,
            NULLIF(sps.size_32, 0) AS size32Quantity,
            NULLIF(sps.size_33, 0) AS size33Quantity,
            NULLIF(sps.size_34, 0) AS size34Quantity,
            NULLIF(sps.size_35, 0) AS size35Quantity,
            NULLIF(sps.size_36, 0) AS size36Quantity,
            NULLIF(sps.size_37, 0) AS size37Quantity,
            NULLIF(sps.size_38, 0) AS size38Quantity,
            NULLIF(sps.size_39, 0) AS size39Quantity,
            NULLIF(sps.size_40, 0) AS size40Quantity,
            NULLIF(sps.size_41, 0) AS size41Quantity,
            NULLIF(sps.size_42, 0) AS size42Quantity,
            NULLIF(sps.size_43, 0) AS size43Quantity,
            COALESCE ( sps.size_30, 0 ) + COALESCE ( sps.size_31, 0 ) + COALESCE ( sps.size_32, 0 ) + COALESCE ( sps.size_33, 0 ) + COALESCE ( sps.size_34, 0 ) +
            COALESCE ( sps.size_35, 0 ) + COALESCE ( sps.size_36, 0 ) + COALESCE ( sps.size_37, 0 ) + COALESCE ( sps.size_38, 0 ) + COALESCE ( sps.size_39, 0 ) +
            COALESCE ( sps.size_40, 0 ) + COALESCE ( sps.size_41, 0 ) + COALESCE ( sps.size_42, 0 ) + COALESCE ( sps.size_43, 0 ) AS totalQuantity
        FROM
            store_product_stock sps
        WHERE
            sps.del_flag = 0
            AND sps.store_prod_color_id IN
            <foreach collection="storeProdColorIdList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        ORDER BY
            sps.store_prod_id,
            sps.store_color_id
    </select>

    <select id="selectWebsitePage" resultType="com.ruoyi.xkt.dto.storeProductStock.StoreProdStockWebsitePageResDTO">
        SELECT
            sps.id AS storeProdStockId,
            sp.store_id,
            s.store_name,
            sps.store_prod_id,
            sf.file_url AS mainPicUrl,
            sp.prod_art_num,
            sps.color_name,
            spcs_min.min_price AS price,
            NULLIF( sps.size_30, 0 ) AS size30,
            NULLIF( sps.size_31, 0 ) AS size31,
            NULLIF( sps.size_32, 0 ) AS size32,
            NULLIF( sps.size_33, 0 ) AS size33,
            NULLIF( sps.size_34, 0 ) AS size34,
            NULLIF( sps.size_35, 0 ) AS size35,
            NULLIF( sps.size_36, 0 ) AS size36,
            NULLIF( sps.size_37, 0 ) AS size37,
            NULLIF( sps.size_38, 0 ) AS size38,
            NULLIF( sps.size_39, 0 ) AS size39,
            NULLIF( sps.size_40, 0 ) AS size40,
            NULLIF( sps.size_41, 0 ) AS size41,
            NULLIF( sps.size_42, 0 ) AS size42,
            NULLIF( sps.size_43, 0 ) AS size43,
            ( IFNULL( sps.size_30, 0 ) + IFNULL( sps.size_31, 0 ) + IFNULL( sps.size_32, 0 ) + IFNULL( sps.size_33, 0 ) + IFNULL( sps.size_34, 0 ) +
              IFNULL( sps.size_35, 0 ) + IFNULL( sps.size_36, 0 ) + IFNULL( sps.size_37, 0 ) + IFNULL( sps.size_38, 0 ) + IFNULL( sps.size_39, 0 ) +
              IFNULL( sps.size_40, 0 ) + IFNULL( sps.size_41, 0 ) + IFNULL( sps.size_42, 0 ) + IFNULL( sps.size_43, 0 )) AS totalStock
        FROM
            store_product_stock sps
                JOIN store_product sp ON sps.store_prod_id = sp.id AND sps.del_flag = 0
                JOIN store s ON sp.store_id = s.id
                JOIN store_product_file spf ON sp.id = spf.store_prod_id AND spf.file_type = 1 AND spf.order_num = 1 AND spf.del_flag = 0
                JOIN sys_file sf ON spf.file_id = sf.id
                LEFT JOIN ( SELECT store_prod_id, MIN( price ) AS min_price
                    FROM store_product_color_size WHERE del_flag = 0 GROUP BY store_prod_id ) spcs_min ON sp.id = spcs_min.store_prod_id
        <where>
            <if test="prodArtNum != null and prodArtNum != ''">
                AND sp.prod_art_num LIKE CONCAT( '%', #{prodArtNum}, '%' )
            </if>
        </where>
    </select>


</mapper>