<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.sale.mapper.SysSaleOrderMapper">

    <resultMap type="SysSaleOrder" id="SysSaleOrderResult">
        <result property="orderId" column="order_id"/>
        <result property="orderNo" column="order_no"/>
        <result property="orderType" column="order_type"/>
        <result property="userId" column="user_id"/>
        <result property="actualFee" column="actual_fee"/>
        <result property="totalFee" column="total_fee"/>
        <result property="discountRule" column="discount_rule"/>
        <result property="discountFee" column="discount_fee"/>
        <result property="payMode" column="pay_mode"/>
        <result property="status" column="status"/>
        <result property="contact" column="contact"/>
        <result property="queryPass" column="query_pass"/>
        <result property="createBy" column="create_by"/>
        <result property="createTime" column="create_time"/>
        <result property="paymentTime" column="payment_time"/>
        <result property="deliveryTime" column="delivery_time"/>
        <result property="finishTime" column="finish_time"/>
        <result property="closeTime" column="close_time"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateTime" column="update_time"/>
        <result property="remark" column="remark"/>
        <result property="expireTime" column="expire_time"/>
        <result property="tradeNo" column="trade_no"/>
        <result property="manualDelivery" column="manual_delivery"/>
        <result property="delFlag" column="del_flag"/>
    </resultMap>

    <resultMap id="SysSaleOrderSysSaleOrderItemResult" type="SysSaleOrder" extends="SysSaleOrderResult">
        <collection property="sysSaleOrderItemList" notNullColumn="sub_item_id" javaType="java.util.List"
                    resultMap="SysSaleOrderItemResult"/>
    </resultMap>

    <resultMap type="SysSaleOrderItem" id="SysSaleOrderItemResult">
        <result property="itemId" column="sub_item_id"/>
        <result property="orderId" column="sub_order_id"/>
        <result property="templateType" column="sub_template_type"/>
        <result property="templateId" column="sub_template_id"/>
        <result property="num" column="sub_num"/>
        <result property="title" column="sub_title"/>
        <result property="price" column="sub_price"/>
        <result property="totalFee" column="sub_total_fee"/>
        <result property="discountRule" column="sub_discount_rule"/>
        <result property="discountFee" column="sub_discount_fee"/>
        <result property="actualFee" column="sub_actual_fee"/>
    </resultMap>

    <sql id="selectSysSaleOrderVo">
        select order_id,
               order_no,
               order_type,
               user_id,
               actual_fee,
               total_fee,
               discount_rule,
               discount_fee,
               pay_mode,
               status,
               contact,
               query_pass,
               create_by,
               create_time,
               payment_time,
               delivery_time,
               finish_time,
               close_time,
               update_by,
               update_time,
               remark,
               expire_time,
               trade_no,
               manual_delivery,
               del_flag
        from sys_sale_order
    </sql>

    <select id="selectSysSaleOrderList" parameterType="SysSaleOrder" resultMap="SysSaleOrderResult">
        <include refid="selectSysSaleOrderVo"/>
        where del_flag = '0'
        <if test="orderNo != null and orderNo != ''">and order_no = #{orderNo}</if>
        <if test="orderType != null ">and order_type = #{orderType}</if>
        <if test="tradeNo != null and tradeNo != ''">and trade_no = #{tradeNo}</if>
        <if test="userId != null ">and user_id = #{userId}</if>
        <if test="payMode != null and payMode != ''">and pay_mode = #{payMode}</if>
        <if test="status != null ">and status = #{status}</if>
        <if test="contact != null and contact != ''">and contact = #{contact}</if>
        <if test="queryPass != null and queryPass != ''">and query_pass = #{queryPass}</if>
        <if test="remark != null and remark != ''">and remark like concat('%', #{remark}, '%')</if>
        order by order_id desc
    </select>

    <!--suppress SqlResolve -->
    <select id="selectSysSaleOrderQueryLimit" parameterType="SysSaleOrder" resultMap="SysSaleOrderResult">
        <include refid="selectSysSaleOrderVo"/>
        where del_flag = '0'
        <if test="orderNo != null  and orderNo != ''">and order_no = #{orderNo}</if>
        <if test="orderType != null ">and order_type = #{orderType}</if>
        <if test="userId != null ">and user_id = #{userId}</if>
        <if test="payMode != null  and payMode != ''">and pay_mode = #{payMode}</if>
        <if test="status != null ">and status = #{status}</if>
        <if test="contact != null  and contact != ''">and contact = #{contact}</if>
        <if test="queryPass != null  and queryPass != ''">and query_pass = #{queryPass}</if>
        order by order_id desc limit #{limit}
    </select>

    <select id="selectSysSaleOrderByOrderId" parameterType="Long" resultMap="SysSaleOrderSysSaleOrderItemResult">
        select a.order_id,
               a.order_no,
               a.order_type,
               a.user_id,
               a.actual_fee,
               a.total_fee,
               a.discount_rule,
               a.discount_fee,
               a.pay_mode,
               a.status,
               a.contact,
               a.query_pass,
               a.create_by,
               a.create_time,
               a.payment_time,
               a.delivery_time,
               a.finish_time,
               a.close_time,
               a.update_by,
               a.update_time,
               a.remark,
               a.expire_time,
               a.trade_no,
               a.manual_delivery,
               a.del_flag,
               b.item_id       as sub_item_id,
               b.order_id      as sub_order_id,
               b.template_type as sub_template_type,
               b.template_id   as sub_template_id,
               b.num           as sub_num,
               b.title         as sub_title,
               b.price         as sub_price,
               b.total_fee     as sub_total_fee,
               b.discount_rule as sub_discount_rule,
               b.discount_fee  as sub_discount_fee,
               b.actual_fee    as sub_actual_fee
        from sys_sale_order a
                 left join sys_sale_order_item b on b.order_id = a.order_id
        where a.order_id = #{orderId}
          and a.del_flag = '0'
    </select>

    <select id="selectSysSaleOrderByOrderNo" parameterType="String" resultMap="SysSaleOrderSysSaleOrderItemResult">
        select a.order_id,
               a.order_no,
               a.order_type,
               a.user_id,
               a.actual_fee,
               a.total_fee,
               a.discount_rule,
               a.discount_fee,
               a.pay_mode,
               a.status,
               a.contact,
               a.query_pass,
               a.create_by,
               a.create_time,
               a.payment_time,
               a.delivery_time,
               a.finish_time,
               a.close_time,
               a.update_by,
               a.update_time,
               a.remark,
               a.expire_time,
               a.trade_no,
               a.manual_delivery,
               a.del_flag,
               b.item_id       as sub_item_id,
               b.order_id      as sub_order_id,
               b.template_type as sub_template_type,
               b.template_id   as sub_template_id,
               b.num           as sub_num,
               b.title         as sub_title,
               b.price         as sub_price,
               b.total_fee     as sub_total_fee,
               b.discount_rule as sub_discount_rule,
               b.discount_fee  as sub_discount_fee,
               b.actual_fee    as sub_actual_fee
        from sys_sale_order a
                 left join sys_sale_order_item b on b.order_id = a.order_id
        where a.order_no = #{orderNo}
          and a.del_flag = '0'
    </select>

    <insert id="insertSysSaleOrder" parameterType="SysSaleOrder" useGeneratedKeys="true" keyProperty="orderId">
        insert into sys_sale_order
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="orderNo != null">order_no,</if>
            <if test="orderType != null">order_type,</if>
            <if test="userId != null">user_id,</if>
            <if test="actualFee != null">actual_fee,</if>
            <if test="totalFee != null">total_fee,</if>
            <if test="discountRule != null">discount_rule,</if>
            <if test="discountFee != null">discount_fee,</if>
            <if test="payMode != null">pay_mode,</if>
            <if test="status != null">status,</if>
            <if test="contact != null">contact,</if>
            <if test="queryPass != null">query_pass,</if>
            <if test="createBy != null">create_by,</if>
            <if test="createTime != null">create_time,</if>
            <if test="paymentTime != null">payment_time,</if>
            <if test="deliveryTime != null">delivery_time,</if>
            <if test="finishTime != null">finish_time,</if>
            <if test="closeTime != null">close_time,</if>
            <if test="updateBy != null">update_by,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="remark != null">remark,</if>
            <if test="expireTime != null">expire_time,</if>
            <if test="tradeNo != null">trade_no,</if>
            <if test="manualDelivery != null">manual_delivery,</if>
            <if test="delFlag != null">del_flag,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="orderNo != null">#{orderNo},</if>
            <if test="orderType != null">#{orderType},</if>
            <if test="userId != null">#{userId},</if>
            <if test="actualFee != null">#{actualFee},</if>
            <if test="totalFee != null">#{totalFee},</if>
            <if test="discountRule != null">#{discountRule},</if>
            <if test="discountFee != null">#{discountFee},</if>
            <if test="payMode != null">#{payMode},</if>
            <if test="status != null">#{status},</if>
            <if test="contact != null">#{contact},</if>
            <if test="queryPass != null">#{queryPass},</if>
            <if test="createBy != null">#{createBy},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="paymentTime != null">#{paymentTime},</if>
            <if test="deliveryTime != null">#{deliveryTime},</if>
            <if test="finishTime != null">#{finishTime},</if>
            <if test="closeTime != null">#{closeTime},</if>
            <if test="updateBy != null">#{updateBy},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="remark != null">#{remark},</if>
            <if test="expireTime != null">#{expireTime},</if>
            <if test="tradeNo != null">#{tradeNo},</if>
            <if test="manualDelivery != null">#{manualDelivery},</if>
            <if test="delFlag != null">#{delFlag},</if>
        </trim>
    </insert>

    <update id="updateSysSaleOrder" parameterType="SysSaleOrder">
        update sys_sale_order
        <trim prefix="SET" suffixOverrides=",">
            <if test="orderNo != null">order_no = #{orderNo},</if>
            <if test="orderType != null">order_type = #{orderType},</if>
            <if test="userId != null">user_id = #{userId},</if>
            <if test="actualFee != null">actual_fee = #{actualFee},</if>
            <if test="totalFee != null">total_fee = #{totalFee},</if>
            <if test="discountRule != null">discount_rule = #{discountRule},</if>
            <if test="discountFee != null">discount_fee = #{discountFee},</if>
            <if test="payMode != null">pay_mode = #{payMode},</if>
            <if test="status != null">status = #{status},</if>
            <if test="contact != null">contact = #{contact},</if>
            <if test="queryPass != null">query_pass = #{queryPass},</if>
            <if test="createBy != null">create_by = #{createBy},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="paymentTime != null">payment_time = #{paymentTime},</if>
            <if test="deliveryTime != null">delivery_time = #{deliveryTime},</if>
            <if test="finishTime != null">finish_time = #{finishTime},</if>
            <if test="closeTime != null">close_time = #{closeTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="expireTime != null">expire_time = #{expireTime},</if>
            <if test="tradeNo != null">trade_no = #{tradeNo},</if>
            <if test="manualDelivery != null">manual_delivery = #{manualDelivery},</if>
            <if test="delFlag != null">del_flag = #{delFlag},</if>
        </trim>
        where order_id = #{orderId}
    </update>

    <!--    <delete id="deleteSysSaleOrderByOrderId" parameterType="Long">-->
    <!--        delete-->
    <!--        from sys_sale_order-->
    <!--        where order_id = #{orderId}-->
    <!--    </delete>-->

    <!--    <delete id="deleteSysSaleOrderByOrderIds" parameterType="String">-->
    <!--        delete from sys_sale_order where order_id in-->
    <!--        <foreach item="orderId" collection="array" open="(" separator="," close=")">-->
    <!--            #{orderId}-->
    <!--        </foreach>-->
    <!--    </delete>-->

    <delete id="deleteSysSaleOrderByOrderId" parameterType="Long">
        update sys_sale_order
        set del_flag = '2'
        where order_id = #{appId}
    </delete>

    <delete id="deleteSysSaleOrderByOrderIds" parameterType="String">
        update sys_sale_order set del_flag = '2' where order_id in
        <foreach collection="array" item="orderId" open="(" separator="," close=")">
            #{orderId}
        </foreach>
    </delete>

    <delete id="deleteSysSaleOrderItemByOrderIds" parameterType="String">
        delete from sys_sale_order_item where order_id in
        <foreach item="orderId" collection="array" open="(" separator="," close=")">
            #{orderId}
        </foreach>
    </delete>

    <delete id="deleteSysSaleOrderItemByOrderId" parameterType="Long">
        delete
        from sys_sale_order_item
        where order_id = #{orderId}
    </delete>

    <insert id="batchSysSaleOrderItem">
        insert into sys_sale_order_item( item_id, order_id, template_type, template_id, num, title, price, total_fee,
        discount_rule, discount_fee, actual_fee) values
        <foreach item="item" index="index" collection="list" separator=",">
            ( #{item.itemId}, #{item.orderId}, #{item.templateType}, #{item.templateId}, #{item.num}, #{item.title},
            #{item.price}, #{item.totalFee}, #{item.discountRule}, #{item.discountFee}, #{item.actualFee})
        </foreach>
    </insert>
</mapper>