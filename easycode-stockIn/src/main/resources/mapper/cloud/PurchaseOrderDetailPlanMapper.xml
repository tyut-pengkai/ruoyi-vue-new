<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.easycode.cloud.mapper.PurchaseOrderDetailPlanMapper">

    <resultMap type="PurchaseOrderDetailPlan" id="PurchaseOrderDetailPlanResult">
        <result property="id"    column="id"    />
        <result property="factoryName"    column="factory_name"    />
        <result property="factoryCode"    column="factory_code"    />
        <result property="materialNo"    column="material_no"    />
        <result property="materialName"    column="material_name"    />
        <result property="oldMaterialNo"    column="old_material_no"    />
        <result property="deliveryDate"    column="delivery_date"    />
        <result property="purchaseOrderNo"    column="purchase_order_no"    />
        <result property="purchaseLineNo"    column="purchase_line_no"    />
        <result property="deliveryLineNo"    column="delivery_line_no"    />
        <result property="unit"    column="unit"    />
        <result property="totalPlanQty"    column="total_plan_qty"    />
        <result property="totalQty"    column="total_qty"    />
        <result property="planQty"    column="plan_qty"    />
        <result property="madeQty"    column="made_qty"    />
        <result property="sapReceivedQty"    column="sap_received_qty"    />
        <result property="stoLocation"    column="sto_location"    />
        <result property="isExempted"    column="is_exempted"    />
        <result property="isConsigned"    column="is_consigned"    />
        <result property="noDeliveryFlag"    column="no_delivery_flag"    />
        <result property="excFinFlag"    column="exc_fin_flag"    />
        <result property="batchNo"    column="batch_no"    />
        <result property="delFlag"    column="del_flag"    />
        <result property="wmsReceivedQty"    column="wms_received_qty"    />
        <result property="materialGroup"    column="material_group"    />
        <result property="materialGroupDesc"    column="material_group_desc"    />
        <result property="tenantId"    column="tenant_id"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
    </resultMap>

    <sql id="selectPurchaseOrderDetailPlanVo">
        select id, factory_name, factory_code, material_no, material_name, old_material_no, delivery_date, purchase_order_no, purchase_line_no, delivery_line_no, unit, total_plan_qty, total_qty, plan_qty, made_qty, sap_received_qty, sto_location, is_exempted, is_consigned, no_delivery_flag, exc_fin_flag, batch_no, del_flag, wms_received_qty, material_group, material_group_desc, tenant_id, create_by, create_time, update_by, update_time from wms_purchase_order_detail_plan
    </sql>

    <select id="selectPurchaseOrderDetailPlanList" parameterType="PurchaseOrderDetailPlan" resultMap="PurchaseOrderDetailPlanResult">
        <include refid="selectPurchaseOrderDetailPlanVo"/>
        <where>
            <if test="factoryName != null  and factoryName != ''"> and factory_name like concat('%', #{factoryName}, '%')</if>
            <if test="factoryCode != null  and factoryCode != ''"> and factory_code = #{factoryCode}</if>
            <if test="materialNo != null  and materialNo != ''"> and material_no = #{materialNo}</if>
            <if test="materialName != null  and materialName != ''"> and material_name like concat('%', #{materialName}, '%')</if>
            <if test="oldMaterialNo != null  and oldMaterialNo != ''"> and old_material_no = #{oldMaterialNo}</if>
            <if test="deliveryDate != null "> and delivery_date = #{deliveryDate}</if>
            <if test="purchaseOrderNo != null  and purchaseOrderNo != ''"> and purchase_order_no = #{purchaseOrderNo}</if>
            <if test="purchaseLineNo != null "> and purchase_line_no = #{purchaseLineNo}</if>
            <if test="deliveryLineNo != null  and deliveryLineNo != ''"> and delivery_line_no = #{deliveryLineNo}</if>
            <if test="unit != null  and unit != ''"> and unit = #{unit}</if>
            <if test="totalPlanQty != null "> and total_plan_qty = #{totalPlanQty}</if>
            <if test="totalQty != null "> and total_qty = #{totalQty}</if>
            <if test="planQty != null "> and plan_qty = #{planQty}</if>
            <if test="madeQty != null "> and made_qty = #{madeQty}</if>
            <if test="sapReceivedQty != null "> and sap_received_qty = #{sapReceivedQty}</if>
            <if test="stoLocation != null  and stoLocation != ''"> and sto_location = #{stoLocation}</if>
            <if test="isExempted != null  and isExempted != ''"> and is_exempted = #{isExempted}</if>
            <if test="isConsigned != null  and isConsigned != ''"> and is_consigned = #{isConsigned}</if>
            <if test="noDeliveryFlag != null  and noDeliveryFlag != ''"> and no_delivery_flag = #{noDeliveryFlag}</if>
            <if test="excFinFlag != null  and excFinFlag != ''"> and exc_fin_flag = #{excFinFlag}</if>
            <if test="batchNo != null  and batchNo != ''"> and batch_no = #{batchNo}</if>
            <if test="wmsReceivedQty != null "> and wms_received_qty = #{wmsReceivedQty}</if>
            <if test="materialGroup != null  and materialGroup != ''"> and material_group = #{materialGroup}</if>
            <if test="materialGroupDesc != null  and materialGroupDesc != ''"> and material_group_desc = #{materialGroupDesc}</if>
            <if test="materialGroupDesc != null  and delFlag != ''"> and del_flag = #{delFlag}</if>
            <if test="tenantId != null "> and tenant_id = #{tenantId}</if>
        </where>
    </select>

    <select id="selectPurchaseOrderDetailPlanById" parameterType="Long" resultMap="PurchaseOrderDetailPlanResult">
        <include refid="selectPurchaseOrderDetailPlanVo"/>
        where id = #{id}
    </select>

    <select id="selectOrderDetailPlanFirstDay" parameterType="PurchaseOrderDetailPlan" resultMap="PurchaseOrderDetailPlanResult">
        <include refid="selectPurchaseOrderDetailPlanVo"/>
        <where>
            <if test="factoryName != null  and factoryName != ''"> and factory_name like concat('%', #{factoryName}, '%')</if>
            <if test="factoryCode != null  and factoryCode != ''"> and factory_code = #{factoryCode}</if>
            <if test="materialNo != null  and materialNo != ''"> and material_no = #{materialNo}</if>
            <if test="materialName != null  and materialName != ''"> and material_name like concat('%', #{materialName}, '%')</if>
            <if test="oldMaterialNo != null  and oldMaterialNo != ''"> and old_material_no = #{oldMaterialNo}</if>
            <if test="deliveryDate != null "> and delivery_date = #{deliveryDate}</if>
            <if test="purchaseOrderNo != null  and purchaseOrderNo != ''"> and purchase_order_no = #{purchaseOrderNo}</if>
            <if test="purchaseLineNo != null "> and purchase_line_no = #{purchaseLineNo}</if>
            <if test="deliveryLineNo != null  and deliveryLineNo != ''"> and delivery_line_no = #{deliveryLineNo}</if>
            <if test="unit != null  and unit != ''"> and unit = #{unit}</if>
            <if test="totalPlanQty != null "> and total_plan_qty = #{totalPlanQty}</if>
            <if test="totalQty != null "> and total_qty = #{totalQty}</if>
            <if test="planQty != null "> and plan_qty = #{planQty}</if>
            <if test="madeQty != null "> and made_qty = #{madeQty}</if>
            <if test="sapReceivedQty != null "> and sap_received_qty = #{sapReceivedQty}</if>
            <if test="stoLocation != null  and stoLocation != ''"> and sto_location = #{stoLocation}</if>
            <if test="isExempted != null  and isExempted != ''"> and is_exempted = #{isExempted}</if>
            <if test="isConsigned != null  and isConsigned != ''"> and is_consigned = #{isConsigned}</if>
            <if test="noDeliveryFlag != null  and noDeliveryFlag != ''"> and no_delivery_flag = #{noDeliveryFlag}</if>
            <if test="excFinFlag != null  and excFinFlag != ''"> and exc_fin_flag = #{excFinFlag}</if>
            <if test="batchNo != null  and batchNo != ''"> and batch_no = #{batchNo}</if>
            <if test="wmsReceivedQty != null "> and wms_received_qty = #{wmsReceivedQty}</if>
            <if test="materialGroup != null  and materialGroup != ''"> and material_group = #{materialGroup}</if>
            <if test="materialGroupDesc != null  and materialGroupDesc != ''"> and material_group_desc = #{materialGroupDesc}</if>
            <if test="delFlag != null  and delFlag != ''"> and del_flag = #{delFlag}</if>
            AND delivery_date >= DATE_FORMAT(DATE_SUB( NOW(), INTERVAL 1 MONTH ),'%Y-%m-01')
        </where>
    </select>

    <select id="queryPurchaseOrderDetailPlan" parameterType="PurchaseOrderDetailPlan" resultMap="PurchaseOrderDetailPlanResult">
        SELECT
            wpodp.id,
            wpodp.factory_name,
            wpodp.factory_code,
            wpodp.material_no,
            wpodp.material_name,
            wpodp.old_material_no,
            wpodp.delivery_date,
            wpodp.purchase_order_no,
            wpodp.purchase_line_no,
            wpodp.delivery_line_no,
            wpodp.unit,
            wpod.total_plan_qty,
            wpod.total_qty,
            wpodp.plan_qty,
            wpodp.sap_received_qty,
            wpodp.sto_location,
            wpodp.is_exempted,
            wpodp.is_consigned,
            wpodp.no_delivery_flag,
            wpodp.exc_fin_flag,
            wpodp.batch_no,
            wpodp.del_flag,
            wpodp.wms_received_qty,
            wpodp.material_group,
            wpodp.material_group_desc,
            wpodp.create_by,
            wpodp.create_time,
            wpodp.update_by,
            wpodp.update_time,
            wpodp.made_qty
        FROM
            wms_purchase_order_detail_plan AS wpodp
                LEFT JOIN wms_purchase_order_detail AS wpod ON wpodp.purchase_order_no = wpod.purchase_order_no
                AND wpodp.purchase_line_no = wpod.purchase_line_no
        <where>
            <if test="factoryName != null  and factoryName != ''"> and wpodp.factory_name like concat('%', #{factoryName}, '%')</if>
            <if test="factoryCode != null  and factoryCode != ''"> and wpodp.factory_code = #{factoryCode}</if>
            <if test="materialNo != null  and materialNo != ''"> and wpodp.material_no = #{materialNo}</if>
            <if test="materialName != null  and materialName != ''"> and wpodp.material_name like concat('%', #{materialName}, '%')</if>
            <if test="oldMaterialNo != null  and oldMaterialNo != ''"> and wpodp.old_material_no = #{oldMaterialNo}</if>
            <if test="purchaseOrderNo != null  and purchaseOrderNo != ''"> and wpodp.purchase_order_no = #{purchaseOrderNo}</if>
            <if test="purchaseLineNo != null "> and wpodp.purchase_line_no = #{purchaseLineNo}</if>
            <if test="deliveryLineNo != null  and deliveryLineNo != ''"> and wpodp.delivery_line_no = #{deliveryLineNo}</if>
            <if test="stoLocation != null  and stoLocation != ''"> and wpodp.sto_location = #{stoLocation}</if>
            <if test="isExempted != null  and isExempted != ''"> and wpodp.is_exempted = #{isExempted}</if>
            <if test="isConsigned != null  and isConsigned != ''"> and wpodp.is_consigned = #{isConsigned}</if>
            <if test="materialGroup != null  and materialGroup != ''"> and wpodp.material_group = #{materialGroup}</if>
            <if test="materialGroupDesc != null  and materialGroupDesc != ''"> and wpodp.material_group_desc = #{materialGroupDesc}</if>
            <if test="delFlag != null  and delFlag != ''"> and wpodp.del_flag = #{delFlag}</if>
            <if test="supplierPeriod != null "> and wpodp.delivery_date &lt; #{supplierPeriod}</if>
        </where>
    </select>

    <select id="selectPurchaseOrderDetailPlanListBySupplierPeriod" parameterType="PurchaseDto" resultMap="PurchaseOrderDetailPlanResult">
        SELECT
        purchase_order_no,
        purchase_line_no,
        SUM(plan_qty - made_qty) AS plan_qty,
        SUM(made_qty) AS made_qty,
        SUM( sap_received_qty ) AS sap_received_qty
        FROM
        wms_purchase_order_detail_plan
        <where>
            and del_flag = '0'
            <if test="purchaseOrderNo != null and purchaseOrderNo != ''"> and purchase_order_no = #{purchaseOrderNo}</if>
            <if test="purchaseLineNo != null and purchaseLineNo != '' "> and purchase_line_no = #{purchaseLineNo}</if>
            <if test="supplierPeriod != null "> and delivery_date &lt; #{supplierPeriod}</if>
        </where>
        GROUP BY purchase_order_no,purchase_line_no
    </select>

    <insert id="insertPurchaseOrderDetailPlan" parameterType="PurchaseOrderDetailPlan" useGeneratedKeys="true" keyProperty="id">
        insert into wms_purchase_order_detail_plan
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="factoryName != null">factory_name,</if>
            <if test="factoryCode != null">factory_code,</if>
            <if test="materialNo != null">material_no,</if>
            <if test="materialName != null">material_name,</if>
            <if test="oldMaterialNo != null">old_material_no,</if>
            <if test="deliveryDate != null">delivery_date,</if>
            <if test="purchaseOrderNo != null">purchase_order_no,</if>
            <if test="purchaseLineNo != null">purchase_line_no,</if>
            <if test="deliveryLineNo != null">delivery_line_no,</if>
            <if test="purchaseOrderId != null">purchase_order_id,</if>
            <if test="purchaseLineNoId != null">purchase_line_no_id,</if>
            <if test="unit != null">unit,</if>
            <if test="totalPlanQty != null">total_plan_qty,</if>
            <if test="totalQty != null">total_qty,</if>
            <if test="planQty != null">plan_qty,</if>
            <if test="madeQty != null">made_qty,</if>
            <if test="sapReceivedQty != null">sap_received_qty,</if>
            <if test="stoLocation != null">sto_location,</if>
            <if test="isExempted != null">is_exempted,</if>
            <if test="isConsigned != null">is_consigned,</if>
            <if test="noDeliveryFlag != null">no_delivery_flag,</if>
            <if test="excFinFlag != null">exc_fin_flag,</if>
            <if test="batchNo != null">batch_no,</if>
            <if test="delFlag != null">del_flag,</if>
            <if test="wmsReceivedQty != null">wms_received_qty,</if>
            <if test="materialGroup != null">material_group,</if>
            <if test="materialGroupDesc != null">material_group_desc,</if>
            <if test="assetNo != null">asset_no,</if>
            <if test="assetTypeDel != null">asset_type_del,</if>
            <if test="baseUnit != null">base_unit,</if>
            <if test="costCenter != null">cost_center,</if>
            <if test="projectNo != null">project_no,</if>
            <if test="purchaseCertificateType != null">purchase_certificate_type,</if>
            <if test="purchaseRefundOrderNo != null">purchase_refund_order_no,</if>
            <if test="returnProject != null">return_project,</if>
            <if test="wbsElement != null">wbs_element,</if>
            <if test="orderNo != null">order_no,</if>
            <if test="orderApplyNo != null">order_apply_no,</if>
            <if test="orderApplyProjectNo != null">order_apply_project_no,</if>
            <if test="deliveryStatus != null">delivery_status,</if>
            <if test="tenantId != null">tenant_id,</if>
            <if test="createBy != null">create_by,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateBy != null">update_by,</if>
            <if test="updateTime != null">update_time,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="factoryName != null">#{factoryName},</if>
            <if test="factoryCode != null">#{factoryCode},</if>
            <if test="materialNo != null">#{materialNo},</if>
            <if test="materialName != null">#{materialName},</if>
            <if test="oldMaterialNo != null">#{oldMaterialNo},</if>
            <if test="deliveryDate != null">#{deliveryDate},</if>
            <if test="purchaseOrderId != null">#{purchaseOrderId},</if>
            <if test="purchaseOrderNo != null">#{purchaseOrderNo},</if>
            <if test="purchaseLineNoId != null">#{purchaseLineNoId},</if>
            <if test="purchaseLineNo != null">#{purchaseLineNo},</if>
            <if test="deliveryLineNo != null">#{deliveryLineNo},</if>
            <if test="unit != null">#{unit},</if>
            <if test="totalPlanQty != null">#{totalPlanQty},</if>
            <if test="totalQty != null">#{totalQty},</if>
            <if test="planQty != null">#{planQty},</if>
            <if test="madeQty != null">#{madeQty},</if>
            <if test="sapReceivedQty != null">#{sapReceivedQty},</if>
            <if test="stoLocation != null">#{stoLocation},</if>
            <if test="isExempted != null">#{isExempted},</if>
            <if test="isConsigned != null">#{isConsigned},</if>
            <if test="noDeliveryFlag != null">#{noDeliveryFlag},</if>
            <if test="excFinFlag != null">#{excFinFlag},</if>
            <if test="batchNo != null">#{batchNo},</if>
            <if test="delFlag != null">#{delFlag},</if>
            <if test="wmsReceivedQty != null">#{wmsReceivedQty},</if>
            <if test="materialGroup != null">#{materialGroup},</if>
            <if test="materialGroupDesc != null">#{materialGroupDesc},</if>
            <if test="assetNo != null">#{assetNo},</if>
            <if test="assetTypeDel != null">#{assetTypeDel},</if>
            <if test="baseUnit != null">#{baseUnit},</if>
            <if test="costCenter != null">#{costCenter},</if>
            <if test="projectNo != null">#{projectNo},</if>
            <if test="purchaseCertificateType != null">#{purchaseCertificateType},</if>
            <if test="purchaseRefundOrderNo != null">#{purchaseRefundOrderNo},</if>
            <if test="returnProject != null">#{returnProject},</if>
            <if test="wbsElement != null">#{wbsElement},</if>
            <if test="orderNo != null">#{orderNo},</if>
            <if test="orderApplyNo != null">#{orderApplyNo},</if>
            <if test="orderApplyProjectNo != null">#{orderApplyProjectNo},</if>
            <if test="deliveryStatus != null">#{deliveryStatus},</if>
            <if test="tenantId != null">#{tenantId},</if>
            <if test="createBy != null">#{createBy},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateBy != null">#{updateBy},</if>
            <if test="updateTime != null">#{updateTime},</if>
        </trim>
    </insert>

    <update id="updatePurchaseOrderDetailPlan" parameterType="PurchaseOrderDetailPlan">
        update wms_purchase_order_detail_plan
        <trim prefix="SET" suffixOverrides=",">
            <if test="factoryName != null">factory_name = #{factoryName},</if>
            <if test="factoryCode != null">factory_code = #{factoryCode},</if>
            <if test="materialNo != null">material_no = #{materialNo},</if>
            <if test="materialName != null">material_name = #{materialName},</if>
            <if test="oldMaterialNo != null">old_material_no = #{oldMaterialNo},</if>
            <if test="deliveryDate != null">delivery_date = #{deliveryDate},</if>
            <if test="purchaseOrderNo != null">purchase_order_no = #{purchaseOrderNo},</if>
            <if test="purchaseLineNo != null">purchase_line_no = #{purchaseLineNo},</if>
            <if test="deliveryLineNo != null">delivery_line_no = #{deliveryLineNo},</if>
            <if test="unit != null">unit = #{unit},</if>
            <if test="totalPlanQty != null">total_plan_qty = #{totalPlanQty},</if>
            <if test="totalQty != null">total_qty = #{totalQty},</if>
            <if test="planQty != null">plan_qty = #{planQty},</if>
            <if test="madeQty != null">made_qty = #{madeQty},</if>
            <if test="sapReceivedQty != null">sap_received_qty = #{sapReceivedQty},</if>
            <if test="stoLocation != null">sto_location = #{stoLocation},</if>
            <if test="isExempted != null">is_exempted = #{isExempted},</if>
            <if test="isConsigned != null">is_consigned = #{isConsigned},</if>
            <if test="noDeliveryFlag != null">no_delivery_flag = #{noDeliveryFlag},</if>
            <if test="excFinFlag != null">exc_fin_flag = #{excFinFlag},</if>
            <if test="batchNo != null">batch_no = #{batchNo},</if>
            <if test="delFlag != null">del_flag = #{delFlag},</if>
            <if test="wmsReceivedQty != null">wms_received_qty = #{wmsReceivedQty},</if>
            <if test="materialGroup != null">material_group = #{materialGroup},</if>
            <if test="materialGroupDesc != null">material_group_desc = #{materialGroupDesc},</if>
            <if test="assetNo != null">asset_no = #{assetNo},</if>
            <if test="assetTypeDel != null">asset_type_del = #{assetTypeDel},</if>
            <if test="baseUnit != null">base_unit = #{baseUnit},</if>
            <if test="costCenter != null">cost_center = #{costCenter},</if>
            <if test="projectNo != null">project_no = #{projectNo},</if>
            <if test="purchaseCertificateType != null">purchase_certificate_type = #{purchaseCertificateType},</if>
            <if test="purchaseRefundOrderNo != null">purchase_refund_order_no = #{purchaseRefundOrderNo},</if>
            <if test="returnProject != null">return_project = #{returnProject},</if>
            <if test="wbsElement != null">wbs_element = #{wbsElement},</if>
            <if test="orderNo != null">order_no = #{orderNo},</if>
            <if test="orderApplyNo != null">order_apply_no = #{orderApplyNo},</if>
            <if test="orderApplyProjectNo != null">order_apply_project_no = #{orderApplyProjectNo},</if>
            <if test="deliveryStatus != null">delivery_status = #{deliveryStatus},</if>
            <if test="tenantId != null">tenant_id = #{tenantId},</if>
            <if test="createBy != null">create_by = #{createBy},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </trim>
        where id = #{id}
    </update>

    <update id="updatePurchaseOrderDetailPlanMadeQty" parameterType="PurchaseOrderDetailPlan">
        update wms_purchase_order_detail_plan
        <trim prefix="SET" suffixOverrides=",">
            <if test="madeQty != null">made_qty = #{madeQty},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </trim>
        where id = #{id}
    </update>

    <delete id="deletePurchaseOrderDetailPlanById" parameterType="Long">
        delete from wms_purchase_order_detail_plan where id = #{id}
    </delete>

    <delete id="deletePurchaseOrderDetailPlanByIds" parameterType="String">
        delete from wms_purchase_order_detail_plan where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <update id="updatePurchaseOrderDetailPlanByIds" parameterType="PurchaseVo">
        update wms_purchase_order_detail_plan set del_flag = '1',update_time = #{updateTime}, old_material_no = #{oldMaterialNo} WHERE id in
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <select id="getPLanInfoByPurchaseNos" parameterType="List" resultMap="PurchaseOrderDetailPlanResult">
        SELECT
        id,
        purchase_order_no,
        purchase_line_no,
        material_no,
        delivery_date,plan_qty,
        made_qty,
        sap_received_qty,
        wms_received_qty
        FROM
        wms_purchase_order_detail_plan podp
        where
            del_flag = '0'
            and purchase_order_no in
        <foreach item="item" collection="list" open="(" separator="," close=")">
            (#{item})
        </foreach>
    </select>

    <update id="clearUntreatedPurchaseData">
        UPDATE wms_purchase_order_detail_plan_raw SET process_flag = 'Y' WHERE id IN (SELECT a.id FROM ( SELECT id FROM wms_purchase_order_detail_plan_raw WHERE process_flag = 'N' ) a);
    </update>
</mapper>
