# 微信小程序登录接口说明

## 概述

为了减少不必要的微信接口调用费用，我们实现了分步骤的微信小程序登录流程。该流程根据用户的不同状态，智能地决定是否需要获取手机号或用户信息。

## 登录流程

### 1. 分步骤登录流程

```
小程序启动
    ↓
获取OpenId (wx.login)
    ↓
调用 /wxStepLogin 检查用户状态
    ↓
根据返回状态决定下一步：
    ├─ loginStatus=1: 登录成功，直接进入应用
    ├─ loginStatus=0: 需要获取手机号
    └─ loginStatus=2: 需要完善用户信息
```

### 2. 登录状态说明

| 状态值 | 说明 | 下一步操作 |
|--------|------|------------|
| 0 | 需要获取手机号 | 调用 wx.getPhoneNumber() |
| 1 | 登录成功 | 保存token，进入应用 |
| 2 | 需要完善用户信息 | 调用 wx.getUserInfo() 和 wx.getPhoneNumber() |

## 接口文档

### 1. 分步骤登录接口

**接口地址：** `POST /wxStepLogin`

**请求参数：**
```json
{
  "code": "微信登录code",
  "encryptedData": "用户信息加密数据（可选）",
  "iv": "用户信息iv（可选）",
  "rawData": "原始数据（可选）",
  "signature": "签名（可选）",
  "phoneEncryptedData": "手机号加密数据（可选）",
  "phoneIv": "手机号iv（可选）",
  "hasPhoneInfo": false
}
```

**响应结果：**
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "loginStatus": 0,
    "token": "登录令牌（仅在登录成功时返回）",
    "openId": "用户openId",
    "hasPhone": false,
    "message": "需要获取手机号"
  }
}
```

### 2. 完善用户信息接口

**接口地址：** `POST /wxCompleteUserInfo`

**请求参数：**
```json
{
  "code": "微信登录code",
  "encryptedData": "用户信息加密数据",
  "iv": "用户信息iv",
  "rawData": "原始数据",
  "signature": "签名",
  "phoneEncryptedData": "手机号加密数据",
  "phoneIv": "手机号iv",
  "hasPhoneInfo": true
}
```

**响应结果：**
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "token": "登录令牌"
  }
}
```

## 小程序端使用示例

### 1. 基础登录流程

```javascript
// 步骤1：获取OpenId并检查用户状态
async getOpenId() {
  try {
    // 调用微信登录获取code
    const loginResult = await this.wxLogin();
    
    // 调用后端接口检查用户状态
    const response = await this.callStepLogin({
      code: loginResult.code,
      hasPhoneInfo: false
    });
    
    const result = response.data;
    
    // 根据登录状态决定下一步
    if (result.loginStatus === 1) {
      // 登录成功
      this.loginSuccess(result.token);
    } else if (result.loginStatus === 0) {
      // 需要获取手机号
      this.getPhoneNumber();
    } else if (result.loginStatus === 2) {
      // 需要完善用户信息
      this.getUserInfo();
    }
  } catch (error) {
    console.error('获取OpenId失败:', error);
  }
}
```

### 2. 获取手机号流程

```javascript
// 步骤2：获取手机号
async getPhoneNumber() {
  try {
    // 获取用户信息
    const userInfo = await this.getUserProfile();
    
    // 获取手机号
    const phoneResult = await this.wxGetPhoneNumber();
    
    // 重新获取code（因为code只能使用一次）
    const loginResult = await this.wxLogin();
    
    // 调用后端接口完成登录
    const response = await this.callStepLogin({
      code: loginResult.code,
      encryptedData: userInfo.encryptedData,
      iv: userInfo.iv,
      rawData: userInfo.rawData,
      signature: userInfo.signature,
      phoneEncryptedData: phoneResult.encryptedData,
      phoneIv: phoneResult.iv,
      hasPhoneInfo: true
    });
    
    const result = response.data;
    if (result.loginStatus === 1) {
      this.loginSuccess(result.token);
    }
  } catch (error) {
    console.error('获取手机号失败:', error);
  }
}
```

### 3. 完善用户信息流程

```javascript
// 步骤3：完善用户信息
async getUserInfo() {
  try {
    // 获取用户信息
    const userInfo = await this.getUserProfile();
    
    // 获取手机号
    const phoneResult = await this.wxGetPhoneNumber();
    
    // 重新获取code
    const loginResult = await this.wxLogin();
    
    // 调用后端接口完善用户信息并登录
    const response = await this.callCompleteUserInfo({
      code: loginResult.code,
      encryptedData: userInfo.encryptedData,
      iv: userInfo.iv,
      rawData: userInfo.rawData,
      signature: userInfo.signature,
      phoneEncryptedData: phoneResult.encryptedData,
      phoneIv: phoneResult.iv,
      hasPhoneInfo: true
    });
    
    this.loginSuccess(response.data.token);
  } catch (error) {
    console.error('完善用户信息失败:', error);
  }
}
```

## 注意事项

### 1. Code使用限制
- 微信登录的code只能使用一次
- 每次调用微信接口后需要重新获取code

### 2. 权限申请
- 获取手机号需要用户主动授权
- 获取用户信息需要用户主动授权

### 3. 错误处理
- 需要妥善处理各种异常情况
- 提供友好的用户提示

### 4. 网络请求
- 建议添加请求超时处理
- 添加网络错误重试机制

## 优势

1. **节省费用**：避免不必要的微信接口调用
2. **用户体验**：根据用户状态智能引导
3. **安全性**：分步骤验证，提高安全性
4. **灵活性**：支持不同的登录场景

## 测试建议

1. 测试新用户首次登录流程
2. 测试已绑定手机号用户登录流程
3. 测试未绑定手机号用户登录流程
4. 测试各种异常情况的处理
5. 测试网络异常的重试机制 