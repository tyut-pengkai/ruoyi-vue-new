<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.xkt.mapper.StoreProductColorMapper">

    <update id="updateDelFlagByStoreProdId" parameterType="Long">
        UPDATE store_product_color SET del_flag = 2 WHERE store_prod_id = #{storeProdId}
    </update>

    <select id="selectListByStoreProdId" parameterType="Long" resultType="com.ruoyi.xkt.dto.storeProdColor.StoreProdColorDTO">
        SELECT
            id AS storeProdColorId,
            store_color_id AS storeColorId,
            color_name AS colorName,
            order_num AS orderNum
        FROM
            store_product_color
        WHERE
            del_flag = 0 AND store_prod_id = #{storeProdId}
    </select>

    <select id="selectStoreProdColorPage" parameterType="com.ruoyi.xkt.dto.storeProduct.StoreProdPageDTO"
            resultType="com.ruoyi.xkt.dto.storeProduct.StoreProdPageResDTO">
        SELECT
            spc.id AS storeProdColorId,
            spc.store_color_id,
            spc.store_prod_id,
            spc.store_id,
            sp.prod_art_num,
            spc.color_name,
            sp.prod_cate_id,
            pc.`name` AS prodCateName,
            spc.prod_status,
            spc.create_time,
            sf.file_url AS mainPicUrl,
            sp.private_item
        FROM
            store_product_color spc
                JOIN store_product sp ON spc.store_prod_id = sp.id
                JOIN sys_product_category pc ON sp.prod_cate_id = pc.id
                JOIN store_product_file spf ON sp.id = spf.store_prod_id AND spf.file_type = 1 AND spf.order_num = 1 AND spf.del_flag = 0
                JOIN sys_file sf ON spf.file_id = sf.id
        WHERE
            spc.del_flag = #{delFlag}  AND spc.store_id = #{storeId}
            <if test="prodStatusList != null and prodStatusList.size() > 0">
                AND spc.prod_status IN
                <foreach item="item" collection="prodStatusList" separator="," open="(" close=")" index="">
                    #{item}
                </foreach>
            </if>
            <if test="prodArtNum != null  and prodArtNum != ''"> and sp.prod_art_num like concat('%', #{prodArtNum}, '%')</if>
            <if test="prodCateId != null "> and sp.prod_cate_id = #{prodCateId}</if>
            <if test="privateItem != null "> and sp.private_item = #{privateItem}</if>
        ORDER BY
            spc.create_time DESC
    </select>

    <select id="fuzzyQueryColorList"  resultType="com.ruoyi.xkt.dto.storeProdColor.StoreProdColorResDTO">
        SELECT DISTINCT
            spc.id AS storeProdColorId,
            sp.store_id AS storeId,
            spc.store_prod_id AS storeProdId,
            spc.store_color_id AS storeColorId,
            sp.prod_art_num AS prodArtNum,
            spc.color_name AS colorName,
            sp.produce_price AS producePrice,
            spc.order_num AS orderNum
        FROM
            store_product_color spc JOIN store_product sp ON spc.store_prod_id = sp.id
        WHERE
            spc.del_flag = 0
            AND spc.store_id = #{storeId}
            <if test="prodArtNum != null  and prodArtNum != ''"> and sp.prod_art_num like concat('%', #{prodArtNum}, '%')</if>
    </select>


    <select id="selectListByStoreProdIdAndStoreId" resultType="com.ruoyi.xkt.dto.storeProdColorPrice.StoreProdColorPriceResDTO">
        SELECT
            spc.id AS storeProdColorId,
            spc.store_id,
            spc.store_color_id,
            sp.prod_art_num,
            spc.color_name,
            (SELECT MIN(spcs.price) FROM store_product_color_size spcs
                WHERE spcs.store_prod_id = spc.store_prod_id AND spcs.store_color_id = spc.store_color_id AND spcs.del_flag = 0) AS price,
            spc.order_num
        FROM
            store_product_color spc
                JOIN store_product sp ON spc.store_prod_id = sp.id
        WHERE
            spc.del_flag = 0
            AND spc.prod_status IN ( 2, 3 )
            AND spc.store_prod_id = #{storeProdId}
            AND spc.store_id = #{storeId}
        ORDER BY
            spc.order_num
    </select>

    <select id="selectColorPricePage" resultType="com.ruoyi.xkt.dto.storeProdColorPrice.StoreProdColorPriceResDTO">
        SELECT
            spc.id AS storeProdColorId,
            sp.store_id,
            spc.store_prod_id,
            spc.store_color_id,
            sp.prod_art_num,
            spc.color_name,
            MIN( spcs.price ) AS price
        FROM
            store_product_color spc
                JOIN store_product sp ON spc.store_prod_id = sp.id
                JOIN store_product_color_size spcs ON spc.store_prod_id = spcs.store_prod_id AND spcs.del_flag = 0
        WHERE
            spc.del_flag = 0 AND sp.store_id = #{storeId}
            <if test="prodArtNum != null  and prodArtNum != ''">
                AND sp.prod_art_num like concat('%', #{prodArtNum}, '%')
            </if>
            <if test="prodStatusList != null and prodStatusList.size() > 0">
                AND spc.prod_status IN
                <foreach item="item" collection="prodStatusList" separator="," open="(" close=")" index="">
                    #{item}
                </foreach>
            </if>
        GROUP BY
            spc.id
    </select>

    <select id="getStatusNum" resultType="com.ruoyi.xkt.dto.storeProduct.StoreProdStatusCountResDTO">
        SELECT
            COALESCE ( SUM( CASE WHEN spc.del_flag = 0 AND spc.prod_status = 1 THEN 1 ELSE 0 END ), 0 ) AS unPublishedNum,
            COALESCE ( SUM( CASE WHEN spc.del_flag = 0 AND spc.prod_status = 2 THEN 1 ELSE 0 END ), 0 ) AS onSaleNum,
            COALESCE ( SUM( CASE WHEN spc.del_flag = 0 AND spc.prod_status = 3 THEN 1 ELSE 0 END ), 0 ) AS tailGoodsNum,
            COALESCE ( SUM( CASE WHEN spc.del_flag = 0 AND spc.prod_status = 4 THEN 1 ELSE 0 END ), 0 ) AS offSaleNum,
            COALESCE ( SUM( CASE WHEN spc.del_flag = 2 AND spc.prod_status = 5 THEN 1 ELSE 0 END ), 0 ) AS removedNum
        FROM
            store_product_color spc
        WHERE
            spc.store_id = #{storeId}
            AND (
                ( spc.del_flag = 0 AND spc.prod_status IN ( 1, 2, 3, 4 ))
                OR ( spc.del_flag = 2 AND spc.prod_status = 5 )
            );
    </select>


</mapper>