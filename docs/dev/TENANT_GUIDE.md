# è‹¥ä¾å¤šç§Ÿæˆ·æ¶æ„å®ç°æŒ‡å—

## æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†è‹¥ä¾æ¡†æ¶çš„å¤šç§Ÿæˆ·SaaSæ¶æ„å®ç°æ–¹æ¡ˆï¼ŒåŒ…æ‹¬è®¾è®¡åŸç†ã€æ ¸å¿ƒç»„ä»¶ã€é›†æˆæ­¥éª¤å’Œæœ€ä½³å®è·µã€‚é€‚åˆå¸Œæœ›åœ¨é¡¹ç›®ä¸­å¼•å…¥å¤šç§Ÿæˆ·åŠŸèƒ½çš„å¼€å‘è€…å­¦ä¹ å’Œå‚è€ƒã€‚

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šå¤šç§Ÿæˆ·æ¶æ„æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯å¤šç§Ÿæˆ·SaaS

**å¤šç§Ÿæˆ·ï¼ˆMulti-Tenancyï¼‰** æ˜¯ä¸€ç§è½¯ä»¶æ¶æ„æ¨¡å¼ï¼Œå•ä¸€åº”ç”¨å®ä¾‹å¯ä»¥åŒæ—¶ä¸ºå¤šä¸ªç§Ÿæˆ·ï¼ˆå®¢æˆ·ç»„ç»‡ï¼‰æä¾›æœåŠ¡ï¼Œæ¯ä¸ªç§Ÿæˆ·çš„æ•°æ®ç›¸äº’éš”ç¦»ï¼Œäº’ä¸å¯è§ã€‚

**å…¸å‹åº”ç”¨åœºæ™¯**ï¼š
- SaaSäº§å“ï¼ˆå¦‚ç†å‘åº—ç®¡ç†ç³»ç»Ÿï¼Œæ¯ä¸ªç†å‘åº—æ˜¯ä¸€ä¸ªç§Ÿæˆ·ï¼‰
- ä¼ä¸šå†…éƒ¨å¤šåˆ†å…¬å¸ç³»ç»Ÿ
- è¿é”é—¨åº—ç®¡ç†å¹³å°
- åŸ¹è®­æœºæ„å¤šæ ¡åŒºç®¡ç†

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **æˆæœ¬ä½**ï¼šå…±äº«æœåŠ¡å™¨èµ„æºï¼Œé™ä½è¿ç»´æˆæœ¬
- **æ˜“ç»´æŠ¤**ï¼šç»Ÿä¸€å‡çº§ï¼Œæ— éœ€ä¸ºæ¯ä¸ªå®¢æˆ·å•ç‹¬éƒ¨ç½²
- **æ˜“æ‰©å±•**ï¼šæ–°å¢ç§Ÿæˆ·åªéœ€æ·»åŠ æ•°æ®è®°å½•ï¼Œæ— éœ€æ”¹ä»£ç 

### 1.2 ä¸‰ç§å¤šç§Ÿæˆ·éš”ç¦»æ¨¡å¼å¯¹æ¯”

| éš”ç¦»æ¨¡å¼ | å®ç°æ–¹å¼ | æ•°æ®éš”ç¦»æ€§ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|---------|---------|-----------|-----|---------|
| **ç‹¬ç«‹æ•°æ®åº“** | æ¯ä¸ªç§Ÿæˆ·ç‹¬ç«‹çš„æ•°æ®åº“å®ä¾‹ | â­â­â­â­â­ æœ€å¼º | ğŸ’°ğŸ’°ğŸ’° æœ€é«˜ | é‡‘èã€åŒ»ç–—ç­‰é«˜å®‰å…¨åœºæ™¯ |
| **å…±äº«æ•°æ®åº“+ç‹¬ç«‹Schema** | åŒä¸€æ•°æ®åº“ï¼Œä¸åŒSchemaï¼ˆMySQLä¸ºdatabaseï¼‰ | â­â­â­â­ å¼º | ğŸ’°ğŸ’° ä¸­ç­‰ | ä¸­å¤§å‹ä¼ä¸šå®¢æˆ· |
| **å…±äº«æ•°æ®åº“+å…±äº«Schema** | é€šè¿‡tenant_idå­—æ®µåŒºåˆ† | â­â­â­ è¾ƒå¼º | ğŸ’° æœ€ä½ | ä¸­å°å‹ç§Ÿæˆ·ï¼Œæ•°é‡è¾ƒå¤š |

**è‹¥ä¾é‡‡ç”¨ç¬¬ä¸‰ç§æ¨¡å¼**ï¼šå…±äº«æ•°æ®åº“+å…±äº«Schema+tenant_idéš”ç¦»

**é€‰å‹ç†ç”±**ï¼š
- æˆæœ¬ä½å»‰ï¼Œé€‚åˆä¸­å°å‹SaaSäº§å“
- å®ç°ç®€å•ï¼Œç»´æŠ¤æ–¹ä¾¿
- é€šè¿‡æ‹¦æˆªå™¨å®ç°è‡ªåŠ¨è¿‡æ»¤ï¼Œä¸šåŠ¡ä»£ç æ— æ„ŸçŸ¥
- æ€§èƒ½ä¼˜ç§€ï¼Œå•åº“å¯æ”¯æŒæ•°åƒç§Ÿæˆ·

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šæ ¸å¿ƒç»„ä»¶å®ç°åŸç†

### 2.1 ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç®¡ç†ï¼ˆTenantContextï¼‰

#### æ ¸å¿ƒè®¾è®¡

**TenantContext** æ˜¯ç§Ÿæˆ·IDçš„å­˜å‚¨å®¹å™¨ï¼ŒåŸºäº `TransmittableThreadLocal` å®ç°ã€‚

**ä¸ºä»€ä¹ˆä¸ç”¨æ™®é€šThreadLocalï¼Ÿ**

| ThreadLocal | TransmittableThreadLocal |
|------------|--------------------------|
| åªèƒ½åœ¨å½“å‰çº¿ç¨‹è®¿é—® | æ”¯æŒçˆ¶å­çº¿ç¨‹ä¼ é€’ |
| çº¿ç¨‹æ± åœºæ™¯ä¸‹ä¼šä¸¢å¤± | çº¿ç¨‹æ± åœºæ™¯ä¸‹è‡ªåŠ¨ä¼ é€’ |
| å¼‚æ­¥ä»»åŠ¡æ— æ³•è·å– | å¼‚æ­¥ä»»åŠ¡è‡ªåŠ¨ç»§æ‰¿ |

è‹¥ä¾æ¡†æ¶å¤§é‡ä½¿ç”¨äº† `@Async` å¼‚æ­¥ä»»åŠ¡å’Œçº¿ç¨‹æ± ï¼Œæ™®é€šThreadLocalä¼šå¯¼è‡´ç§Ÿæˆ·ä¸Šä¸‹æ–‡ä¸¢å¤±ï¼Œå¼•å‘æ•°æ®æ³„éœ²é£é™©ã€‚

#### å…³é”®æ–¹æ³•

```java
public class TenantContext {
    // å­˜å‚¨ç§Ÿæˆ·ID
    private static final TransmittableThreadLocal<Long> TENANT_ID_HOLDER = new TransmittableThreadLocal<>();

    // å­˜å‚¨æ˜¯å¦å¿½ç•¥ç§Ÿæˆ·è¿‡æ»¤ï¼ˆè¶…çº§ç®¡ç†å‘˜ä¸“ç”¨ï¼‰
    private static final TransmittableThreadLocal<Boolean> IGNORE_TENANT = new TransmittableThreadLocal<>();

    // è®¾ç½®å½“å‰ç§Ÿæˆ·ID
    public static void setTenantId(Long tenantId) {
        TENANT_ID_HOLDER.set(tenantId);
    }

    // è·å–å½“å‰ç§Ÿæˆ·ID
    public static Long getTenantId() {
        return TENANT_ID_HOLDER.get();
    }

    // æ¸…é™¤ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼ˆè¯·æ±‚ç»“æŸæ—¶å¿…é¡»è°ƒç”¨ï¼‰
    public static void clear() {
        TENANT_ID_HOLDER.remove();
        IGNORE_TENANT.remove();
    }

    // è®¾ç½®å¿½ç•¥ç§Ÿæˆ·è¿‡æ»¤ï¼ˆè¶…çº§ç®¡ç†å‘˜å…¨å±€æ¨¡å¼ï¼‰
    public static void setIgnore(boolean ignore) {
        IGNORE_TENANT.set(ignore);
    }

    // æ˜¯å¦å¤„äºå…¨å±€æ¨¡å¼
    public static boolean isIgnore() {
        Boolean ignore = IGNORE_TENANT.get();
        return ignore != null && ignore;
    }
}
```

**æ–‡ä»¶ä½ç½®**ï¼š`ruoyi-common/src/main/java/com/ruoyi/common/core/context/TenantContext.java`

#### ç”Ÿå‘½å‘¨æœŸç®¡ç†

```
HTTPè¯·æ±‚è¿›å…¥
  â†’ TenantInterceptor.preHandle() è®¾ç½®ç§Ÿæˆ·ID
  â†’ Controller/Serviceå¤„ç†ä¸šåŠ¡ï¼ˆä»TenantContextè·å–ç§Ÿæˆ·IDï¼‰
  â†’ MyBatisæ‹¦æˆªå™¨è‡ªåŠ¨æ·»åŠ tenant_idè¿‡æ»¤
  â†’ è¯·æ±‚å®Œæˆ
  â†’ TenantInterceptor.afterCompletion() æ¸…é™¤ä¸Šä¸‹æ–‡
```

**ä¸ºä»€ä¹ˆå¿…é¡»æ¸…é™¤ï¼Ÿ**
Tomcatä½¿ç”¨çº¿ç¨‹æ± å¤„ç†è¯·æ±‚ï¼Œå¦‚æœä¸æ¸…é™¤ï¼Œçº¿ç¨‹å¤ç”¨æ—¶ä¼šä¸²ç”¨ä¸Šä¸€ä¸ªè¯·æ±‚çš„ç§Ÿæˆ·IDï¼Œå¯¼è‡´æ•°æ®æ³„éœ²ï¼

---

### 2.2 Webæ‹¦æˆªå™¨ï¼ˆTenantInterceptorï¼‰

#### å·¥ä½œæµç¨‹

```
HTTPè¯·æ±‚
  â†“
åˆ¤æ–­æ˜¯å¦æ˜¯å¿½ç•¥URLï¼ˆç™»å½•ã€éªŒè¯ç ç­‰ï¼‰
  â†“ æ˜¯ â†’ è·³è¿‡ç§Ÿæˆ·æ‹¦æˆª
  â†“ å¦
ä»SecurityContextè·å–LoginUser
  â†“
åˆ¤æ–­ç”¨æˆ·ç±»å‹ï¼š
  â”œâ”€ è¶…çº§ç®¡ç†å‘˜ â†’ TenantContext.setIgnore(true) [å…¨å±€æ¨¡å¼]
  â”œâ”€ æ™®é€šç”¨æˆ·æœ‰tenant_id â†’ TenantContext.setTenantId(tenantId)
  â””â”€ æ™®é€šç”¨æˆ·æ— tenant_id â†’ æŠ›å‡ºå¼‚å¸¸æ‹’ç»è®¿é—®
  â†“
ä¸šåŠ¡å¤„ç†...
  â†“
è¯·æ±‚å®Œæˆ â†’ afterCompletion() â†’ TenantContext.clear()
```

#### æ ¸å¿ƒé€»è¾‘ä»£ç 

```java
@Override
public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
    String requestUri = request.getRequestURI();

    // å¿½ç•¥URLåˆ¤æ–­
    if (TenantConfig.isIgnoreUrl(requestUri)) {
        return true;
    }

    // è·å–ç™»å½•ç”¨æˆ·
    LoginUser loginUser = SecurityUtils.getLoginUser();

    if (loginUser != null) {
        Long userId = loginUser.getUserId();

        // è¶…çº§ç®¡ç†å‘˜ â†’ å…¨å±€æ¨¡å¼
        if (TenantConfig.isSuperAdmin(userId)) {
            TenantContext.setIgnore(true);
            log.warn("ã€è¶…çº§ç®¡ç†å‘˜ã€‘ç”¨æˆ· {} è¿›å…¥å…¨å±€æ¨¡å¼", loginUser.getUsername());
        }
        // æ™®é€šç”¨æˆ· â†’ è®¾ç½®ç§Ÿæˆ·ID
        else if (loginUser.getTenantId() != null) {
            TenantContext.setTenantId(loginUser.getTenantId());
        }
        // æœªåˆ†é…ç§Ÿæˆ· â†’ æ‹’ç»è®¿é—®
        else {
            throw new ServiceException("ç”¨æˆ·æœªåˆ†é…ç§Ÿæˆ·ï¼Œè¯·è”ç³»ç®¡ç†å‘˜");
        }
    }

    return true;
}

@Override
public void afterCompletion(HttpServletRequest request, HttpServletResponse response,
                            Object handler, Exception ex) {
    TenantContext.clear();  // å¿…é¡»æ¸…é™¤ï¼
}
```

**æ–‡ä»¶ä½ç½®**ï¼š`ruoyi-framework/src/main/java/com/ruoyi/framework/interceptor/TenantInterceptor.java`

#### è¶…çº§ç®¡ç†å‘˜æœºåˆ¶

**è¶…çº§ç®¡ç†å‘˜ç‰¹æƒ**ï¼š
- ç™»å½•åè‡ªåŠ¨è¿›å…¥å…¨å±€æ¨¡å¼ï¼ˆ`TenantContext.setIgnore(true)`ï¼‰
- å¯ä»¥æŸ¥çœ‹å’Œæ“ä½œæ‰€æœ‰ç§Ÿæˆ·çš„æ•°æ®
- ç”¨äºç³»ç»Ÿç®¡ç†ã€æ•°æ®è¿ç§»ã€é—®é¢˜æ’æŸ¥

**å®‰å…¨å»ºè®®**ï¼š
- è¶…çº§ç®¡ç†å‘˜è´¦å·å¿…é¡»ä¸¥æ ¼æ§åˆ¶
- æ‰€æœ‰å…¨å±€æ¨¡å¼æ“ä½œåº”è®°å½•å®¡è®¡æ—¥å¿—
- ç”Ÿäº§ç¯å¢ƒå»ºè®®ç¦ç”¨è¶…çº§ç®¡ç†å‘˜çš„æ•°æ®ä¿®æ”¹æƒé™

---

### 2.3 SQLæ‹¦æˆªå™¨ï¼ˆTenantSqlInterceptorï¼‰

#### å·¥ä½œåŸç†

**TenantSqlInterceptor** æ˜¯MyBatisæ’ä»¶ï¼Œæ‹¦æˆªæ‰€æœ‰SQLæ‰§è¡Œï¼Œè‡ªåŠ¨åœ¨WHEREæ¡ä»¶ä¸­æ·»åŠ  `tenant_id = ?` è¿‡æ»¤ã€‚

**æŠ€æœ¯å®ç°**ï¼š
1. æ‹¦æˆªMyBatisçš„ `StatementHandler.prepare()` æ–¹æ³•
2. ä½¿ç”¨ **JSQLParser** è§£æSQLè¯­å¥
3. åˆ¤æ–­ä¸»è¡¨æ˜¯å¦éœ€è¦ç§Ÿæˆ·éš”ç¦»
4. åœ¨WHEREå­å¥ä¸­æ·»åŠ ç§Ÿæˆ·IDæ¡ä»¶
5. å°†æ”¹å†™åçš„SQLè®¾ç½®å›BoundSql

#### SQLæ”¹å†™ç¤ºä¾‹

**åŸå§‹SQL**ï¼š
```sql
SELECT * FROM sys_user WHERE user_name = 'admin'
```

**æ”¹å†™åï¼ˆç§Ÿæˆ·ID=1000ï¼‰**ï¼š
```sql
SELECT * FROM sys_user WHERE tenant_id = 1000 AND user_name = 'admin'
```

**UPDATEè¯­å¥**ï¼š
```sql
-- åŸå§‹
UPDATE sys_user SET nick_name = 'å¼ ä¸‰' WHERE user_id = 2

-- æ”¹å†™
UPDATE sys_user SET nick_name = 'å¼ ä¸‰' WHERE tenant_id = 1000 AND user_id = 2
```

**JOINæŸ¥è¯¢ï¼ˆè‡ªåŠ¨è¯†åˆ«è¡¨åˆ«åï¼‰**ï¼š
```sql
-- åŸå§‹
SELECT u.*, d.dept_name
FROM sys_user u
LEFT JOIN sys_dept d ON u.dept_id = d.dept_id
WHERE u.user_name = 'admin'

-- æ”¹å†™
SELECT u.*, d.dept_name
FROM sys_user u
LEFT JOIN sys_dept d ON u.dept_id = d.dept_id
WHERE u.tenant_id = 1000 AND d.tenant_id = 1000 AND u.user_name = 'admin'
```

#### æ™ºèƒ½åˆ¤æ–­æœºåˆ¶

**åªæ‹¦æˆªä»¥ä¸‹æƒ…å†µ**ï¼š
1. SQLç±»å‹ï¼š`SELECT`ã€`UPDATE`ã€`DELETE`ï¼ˆINSERTä¸æ‹¦æˆªï¼Œç”±ä¸šåŠ¡ä»£ç è®¾ç½®ï¼‰
2. ä¸»è¡¨æ˜¯ç§Ÿæˆ·è¡¨ï¼ˆé…ç½®åœ¨ `TenantConfig.TENANT_TABLES` ä¸­ï¼‰
3. éå…¨å±€æ¨¡å¼ï¼ˆè¶…çº§ç®¡ç†å‘˜è‡ªåŠ¨è·³è¿‡ï¼‰

**ç™½åå•æœºåˆ¶**ï¼š
- å…¨å±€å…±äº«è¡¨ä¸æ‹¦æˆªï¼ˆ`sys_menu`ã€`sys_dict`ã€`sys_config`ç­‰ï¼‰
- æ—¥å¿—è¡¨ä¸æ‹¦æˆªï¼ˆ`sys_logininfor`ã€`sys_oper_log`ï¼‰
- å…³è”è¡¨ä¸æ‹¦æˆªï¼ˆ`sys_user_role`ã€`sys_role_menu`ï¼‰

#### æ ¸å¿ƒæ‹¦æˆªé€»è¾‘

```java
@Override
public Object intercept(Invocation invocation) throws Throwable {
    // è·å–åŸå§‹SQL
    BoundSql boundSql = statementHandler.getBoundSql();
    String originalSql = boundSql.getSql();

    // åˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆª
    if (!shouldIntercept(sqlCommandType, originalSql)) {
        return invocation.proceed();
    }

    // è¶…çº§ç®¡ç†å‘˜å…¨å±€æ¨¡å¼ â†’ è·³è¿‡æ‹¦æˆª
    if (TenantContext.isIgnore()) {
        return invocation.proceed();
    }

    // è·å–ç§Ÿæˆ·ID
    Long tenantId = TenantContext.getTenantId();
    if (tenantId == null) {
        throw new ServiceException("ç§Ÿæˆ·ä¸Šä¸‹æ–‡ä¸¢å¤±ï¼Œè¯·é‡æ–°ç™»å½•");
    }

    // ä½¿ç”¨JSQLParserè§£æå¹¶æ”¹å†™SQL
    String modifiedSql = processSql(originalSql, tenantId, sqlCommandType);

    // è®¾ç½®æ”¹å†™åçš„SQL
    metaObject.setValue("delegate.boundSql.sql", modifiedSql);

    return invocation.proceed();
}
```

**æ–‡ä»¶ä½ç½®**ï¼š`ruoyi-framework/src/main/java/com/ruoyi/framework/interceptor/TenantSqlInterceptor.java`

---

### 2.4 ç™»å½•æµç¨‹é›†æˆ

#### ç™»å½•æµç¨‹å›¾

```
ç”¨æˆ·ç™»å½•
  â†’ ä¸´æ—¶å¼€å¯å…¨å±€æ¨¡å¼ï¼ˆTenantContext.setIgnore(true)ï¼‰
  â†’ Spring SecurityéªŒè¯ç”¨æˆ·åå¯†ç 
  â†’ æŸ¥è¯¢sys_userè¡¨è·å–ç”¨æˆ·ä¿¡æ¯
  â†’ æå–user.tenantId
  â†’ æ£€æŸ¥ï¼šéè¶…çº§ç®¡ç†å‘˜å¿…é¡»æœ‰tenantIdï¼Œå¦åˆ™æ‹’ç»ç™»å½•
  â†’ åˆ›å»ºLoginUserå¯¹è±¡ï¼Œè®¾ç½®tenantId
  â†’ ç”ŸæˆJWT Tokenï¼ˆåŒ…å«tenantIdï¼‰
  â†’ æ¸…é™¤å…¨å±€æ¨¡å¼ï¼ˆTenantContext.clear()ï¼‰
  â†’ è¿”å›Tokenç»™å‰ç«¯
```

#### ä¸ºä»€ä¹ˆç™»å½•æ—¶è¦å¼€å¯å…¨å±€æ¨¡å¼ï¼Ÿ

è¿™æ˜¯ä¸€ä¸ª **"å…ˆæœ‰é¸¡è¿˜æ˜¯å…ˆæœ‰è›‹"** çš„é—®é¢˜ï¼š
- ç”¨æˆ·ç™»å½•æ—¶ï¼Œå°šæœªè®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
- ä½†æŸ¥è¯¢ `sys_user` è¡¨éœ€è¦çŸ¥é“ç§Ÿæˆ·ID
- å¦‚æœä¸å¼€å¯å…¨å±€æ¨¡å¼ï¼ŒSQLæ‹¦æˆªå™¨ä¼šæŠ¥é”™"ç§Ÿæˆ·ä¸Šä¸‹æ–‡ä¸¢å¤±"

**è§£å†³æ–¹æ¡ˆ**ï¼šç™»å½•é˜¶æ®µä¸´æ—¶å¼€å¯å…¨å±€æ¨¡å¼ï¼ŒéªŒè¯é€šè¿‡åç«‹å³å…³é—­ã€‚

#### å…³é”®ä»£ç ç‰‡æ®µ

```java
public String login(String username, String password, String code, String uuid) {
    // ä¸´æ—¶å¼€å¯å…¨å±€æ¨¡å¼
    TenantContext.setIgnore(true);

    try {
        // éªŒè¯ç æ ¡éªŒ
        validateCaptcha(username, code, uuid);

        // Spring Securityè®¤è¯
        Authentication authentication = authenticationManager
            .authenticate(new UsernamePasswordAuthenticationToken(username, password));

        // è·å–ç”¨æˆ·ä¿¡æ¯
        LoginUser loginUser = (LoginUser) authentication.getPrincipal();
        SysUser user = loginUser.getUser();

        // æå–ç§Ÿæˆ·ID
        Long tenantId = user.getTenantId();

        // éè¶…çº§ç®¡ç†å‘˜å¿…é¡»æœ‰ç§Ÿæˆ·ID
        if (!TenantConfig.isSuperAdmin(user.getUserId()) && tenantId == null) {
            throw new ServiceException("ç”¨æˆ·æœªåˆ†é…ç§Ÿæˆ·ï¼Œè¯·è”ç³»ç®¡ç†å‘˜");
        }

        // è®¾ç½®åˆ°LoginUser
        loginUser.setTenantId(tenantId);

        // ç”ŸæˆJWT Token
        return tokenService.createToken(loginUser);

    } finally {
        // æ¸…é™¤å…¨å±€æ¨¡å¼
        TenantContext.clear();
    }
}
```

**æ–‡ä»¶ä½ç½®**ï¼š`ruoyi-framework/src/main/java/com/ruoyi/framework/web/service/SysLoginService.java`

#### åç»­è¯·æ±‚çš„ç§Ÿæˆ·è¯†åˆ«

```
ç”¨æˆ·æºå¸¦Tokenå‘èµ·è¯·æ±‚
  â†’ Spring Securityä»Tokenè§£æå‡ºLoginUser
  â†’ TenantInterceptorä»LoginUseræå–tenantId
  â†’ è®¾ç½®åˆ°TenantContext
  â†’ åç»­æ‰€æœ‰SQLè‡ªåŠ¨æ·»åŠ tenant_idè¿‡æ»¤
```

---

### 2.5 æ•°æ®åº“è®¾è®¡

#### ç§Ÿæˆ·ä¸»è¡¨ï¼ˆsys_tenantï¼‰

```sql
CREATE TABLE `sys_tenant` (
  `tenant_id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'ç§Ÿæˆ·ID',
  `tenant_name` varchar(50) NOT NULL COMMENT 'ç§Ÿæˆ·åç§°',
  `tenant_code` varchar(50) NOT NULL COMMENT 'ç§Ÿæˆ·ç¼–ç ï¼ˆå”¯ä¸€ï¼‰',
  `contact_name` varchar(50) DEFAULT NULL COMMENT 'è”ç³»äºº',
  `contact_phone` varchar(20) DEFAULT NULL COMMENT 'è”ç³»ç”µè¯',
  `expire_time` datetime DEFAULT NULL COMMENT 'è¿‡æœŸæ—¶é—´ï¼ˆNULLè¡¨ç¤ºæ°¸ä¹…ï¼‰',
  `package_id` bigint(20) DEFAULT NULL COMMENT 'å¥—é¤IDï¼ˆé¢„ç•™ï¼‰',
  `status` char(1) NOT NULL DEFAULT '0' COMMENT 'çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰',
  `create_time` datetime DEFAULT NULL,
  `update_time` datetime DEFAULT NULL,
  PRIMARY KEY (`tenant_id`),
  UNIQUE KEY `uk_tenant_code` (`tenant_code`)
) COMMENT='ç§Ÿæˆ·ä¿¡æ¯è¡¨';
```

**SQLè„šæœ¬ä½ç½®**ï¼š`sql/ry_20250522_with_tenant.sql`

#### ä¸šåŠ¡è¡¨æ”¹é€ è§„èŒƒ

**æ‰€æœ‰éœ€è¦éš”ç¦»çš„è¡¨æ·»åŠ tenant_idå­—æ®µ**ï¼š

```sql
ALTER TABLE sys_user ADD COLUMN tenant_id bigint(20) DEFAULT NULL COMMENT 'ç§Ÿæˆ·ID';
ALTER TABLE sys_dept ADD COLUMN tenant_id bigint(20) DEFAULT NULL COMMENT 'ç§Ÿæˆ·ID';
ALTER TABLE sys_role ADD COLUMN tenant_id bigint(20) DEFAULT NULL COMMENT 'ç§Ÿæˆ·ID';

-- åˆ›å»ºç´¢å¼•ï¼ˆå¿…é¡»ï¼ï¼‰
CREATE INDEX idx_tenant_id ON sys_user(tenant_id);
CREATE INDEX idx_tenant_id ON sys_dept(tenant_id);
CREATE INDEX idx_tenant_id ON sys_role(tenant_id);

-- ç”¨æˆ·è¡¨ç‰¹æ®Šå¤„ç†ï¼šå¤åˆç´¢å¼•ï¼ˆæå‡ç™»å½•æŸ¥è¯¢æ€§èƒ½ï¼‰
CREATE INDEX idx_tenant_user ON sys_user(tenant_id, user_name);
```

**ä¸ºä»€ä¹ˆæ˜¯ `DEFAULT NULL` è€Œä¸æ˜¯ `NOT NULL`ï¼Ÿ**
- è¶…çº§ç®¡ç†å‘˜çš„tenant_idä¸ºNULLï¼ˆè¡¨ç¤ºå…¨å±€ç”¨æˆ·ï¼‰
- åˆå§‹åŒ–æ•°æ®å¯èƒ½æ²¡æœ‰ç§Ÿæˆ·ID
- ä¾¿äºæ•°æ®è¿ç§»å’Œæµ‹è¯•

#### è¡¨åˆ†ç±»æ¸…å•

**éœ€è¦éš”ç¦»çš„è¡¨ï¼ˆTENANT_TABLESï¼‰**ï¼š
```
è‹¥ä¾æ¡†æ¶è¡¨ï¼š
- sys_user          ç”¨æˆ·è¡¨
- sys_dept          éƒ¨é—¨è¡¨
- sys_role          è§’è‰²è¡¨
- sys_post          å²—ä½è¡¨
- sys_notice        é€šçŸ¥å…¬å‘Šè¡¨

ä¸šåŠ¡è¡¨ï¼ˆç¤ºä¾‹ï¼‰ï¼š
- hl_customer       å®¢æˆ·è¡¨
- hl_member_card    ä¼šå‘˜å¡è¡¨
- hl_service        æœåŠ¡è¡¨
- hl_staff          å‘˜å·¥è¡¨
- hl_order          è®¢å•è¡¨
```

**å…¨å±€å…±äº«è¡¨ï¼ˆIGNORE_TABLESï¼‰**ï¼š
```
- sys_menu          èœå•è¡¨ï¼ˆæ‰€æœ‰ç§Ÿæˆ·å…±äº«èœå•ï¼‰
- sys_dict_type     å­—å…¸ç±»å‹è¡¨
- sys_dict_data     å­—å…¸æ•°æ®è¡¨
- sys_config        ç³»ç»Ÿé…ç½®è¡¨
- sys_tenant        ç§Ÿæˆ·è¡¨æœ¬èº«
- sys_user_role     ç”¨æˆ·è§’è‰²å…³è”è¡¨
- sys_role_menu     è§’è‰²èœå•å…³è”è¡¨
- sys_role_dept     è§’è‰²éƒ¨é—¨å…³è”è¡¨
- sys_logininfor    ç™»å½•æ—¥å¿—è¡¨
- sys_oper_log      æ“ä½œæ—¥å¿—è¡¨
- sys_job           å®šæ—¶ä»»åŠ¡è¡¨
- sys_job_log       å®šæ—¶ä»»åŠ¡æ—¥å¿—è¡¨
```

**é…ç½®ä½ç½®**ï¼š`ruoyi-common/src/main/java/com/ruoyi/common/config/TenantConfig.java`

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¿«é€Ÿé›†æˆæŒ‡å—

### æ­¥éª¤1ï¼šMavenä¾èµ–é…ç½®

åœ¨æ ¹pom.xmlä¸­æ·»åŠ ä¾èµ–ç‰ˆæœ¬ï¼š

```xml
<properties>
    <!-- å¤šç§Ÿæˆ·ç›¸å…³ä¾èµ–ç‰ˆæœ¬ -->
    <transmittable-thread-local.version>2.14.3</transmittable-thread-local.version>
    <jsqlparser.version>4.6</jsqlparser.version>
</properties>

<dependencyManagement>
    <dependencies>
        <!-- TransmittableThreadLocalï¼šæ”¯æŒçº¿ç¨‹æ± åœºæ™¯çš„ä¸Šä¸‹æ–‡ä¼ é€’ -->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>transmittable-thread-local</artifactId>
            <version>${transmittable-thread-local.version}</version>
        </dependency>

        <!-- JSQLParserï¼šSQLè§£æå™¨ï¼Œç”¨äºSQLæ”¹å†™ -->
        <dependency>
            <groupId>com.github.jsqlparser</groupId>
            <artifactId>jsqlparser</artifactId>
            <version>${jsqlparser.version}</version>
        </dependency>
    </dependencies>
</dependencyManagement>
```

åœ¨ `ruoyi-common/pom.xml` ä¸­å¼•å…¥ï¼š

```xml
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>transmittable-thread-local</artifactId>
</dependency>
```

åœ¨ `ruoyi-framework/pom.xml` ä¸­å¼•å…¥ï¼š

```xml
<dependency>
    <groupId>com.github.jsqlparser</groupId>
    <artifactId>jsqlparser</artifactId>
</dependency>
```

---

### æ­¥éª¤2ï¼šå¤åˆ¶æ ¸å¿ƒç±»æ–‡ä»¶

#### å¿…é¡»å¤åˆ¶çš„æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| TenantContext.java | ruoyi-common/.../context/ | ç§Ÿæˆ·ä¸Šä¸‹æ–‡ |
| TenantConfig.java | ruoyi-common/.../config/ | ç§Ÿæˆ·é…ç½® |
| TenantInterceptor.java | ruoyi-framework/.../interceptor/ | Webæ‹¦æˆªå™¨ |
| TenantSqlInterceptor.java | ruoyi-framework/.../interceptor/ | SQLæ‹¦æˆªå™¨ |
| SysTenant.java | ruoyi-system/.../domain/ | ç§Ÿæˆ·å®ä½“ |
| SysTenantMapper.java | ruoyi-system/.../mapper/ | Mapperæ¥å£ |
| SysTenantMapper.xml | ruoyi-system/.../mapper/system/ | Mapper XML |
| ISysTenantService.java | ruoyi-system/.../service/ | Serviceæ¥å£ |
| SysTenantServiceImpl.java | ruoyi-system/.../service/impl/ | Serviceå®ç° |
| SysTenantController.java | ruoyi-admin/.../controller/system/ | Controller |

#### éœ€è¦ä¿®æ”¹çš„ç°æœ‰æ–‡ä»¶

**1. BaseEntity.java** - æ·»åŠ tenantIdå­—æ®µ

```java
public class BaseEntity implements Serializable {
    // ... ç°æœ‰å­—æ®µ ...

    /** ç§Ÿæˆ·ID */
    @JsonIgnore
    private Long tenantId;

    public Long getTenantId() {
        return tenantId;
    }

    public void setTenantId(Long tenantId) {
        this.tenantId = tenantId;
    }
}
```

**2. SysUser.java** - æ·»åŠ tenantIdå­—æ®µ

```java
public class SysUser extends BaseEntity {
    // ... ç°æœ‰å­—æ®µ ...

    /** ç§Ÿæˆ·ID */
    private Long tenantId;

    public Long getTenantId() {
        return tenantId;
    }

    public void setTenantId(Long tenantId) {
        this.tenantId = tenantId;
    }
}
```

**3. LoginUser.java** - æ·»åŠ tenantIdå­—æ®µ

```java
public class LoginUser implements UserDetails {
    // ... ç°æœ‰å­—æ®µ ...

    /** ç§Ÿæˆ·ID */
    private Long tenantId;

    public Long getTenantId() {
        return tenantId;
    }

    public void setTenantId(Long tenantId) {
        this.tenantId = tenantId;
    }
}
```

**4. SysLoginService.java** - é›†æˆç§Ÿæˆ·é€»è¾‘

åœ¨ `login()` æ–¹æ³•ä¸­æ·»åŠ ç§Ÿæˆ·å¤„ç†é€»è¾‘ï¼ˆå‚è€ƒ2.4èŠ‚ï¼‰ã€‚

**5. TokenService.java** - Tokenä¸­åŒ…å«ç§Ÿæˆ·ID

åœ¨ `createToken()` å’Œ `getLoginUser()` æ–¹æ³•ä¸­æ·»åŠ ç§Ÿæˆ·IDçš„å­˜å–é€»è¾‘ã€‚

---

### æ­¥éª¤3ï¼šæ³¨å†Œæ‹¦æˆªå™¨

#### æ³¨å†ŒWebæ‹¦æˆªå™¨

åœ¨ `ResourcesConfig.java` ä¸­æ³¨å†Œï¼š

```java
@Configuration
public class ResourcesConfig implements WebMvcConfigurer {

    @Autowired
    private TenantInterceptor tenantInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // ç§Ÿæˆ·æ‹¦æˆªå™¨å¿…é¡»åœ¨ç¬¬ä¸€ä½ï¼
        registry.addInterceptor(tenantInterceptor).addPathPatterns("/**");

        // å…¶ä»–æ‹¦æˆªå™¨...
    }
}
```

**æ–‡ä»¶ä½ç½®**ï¼š`ruoyi-framework/src/main/java/com/ruoyi/framework/config/ResourcesConfig.java`

#### æ³¨å†ŒMyBatisæ‹¦æˆªå™¨

åœ¨ `MyBatisConfig.java` ä¸­æ³¨å†Œï¼š

```java
@Configuration
public class MyBatisConfig {

    @Autowired
    private TenantSqlInterceptor tenantSqlInterceptor;

    @Bean
    public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception {
        SqlSessionFactoryBean sessionFactory = new SqlSessionFactoryBean();
        // ... å…¶ä»–é…ç½® ...

        // æ³¨å†Œç§Ÿæˆ·SQLæ‹¦æˆªå™¨
        sessionFactory.setPlugins(tenantSqlInterceptor);

        return sessionFactory.getObject();
    }
}
```

**æ–‡ä»¶ä½ç½®**ï¼š`ruoyi-framework/src/main/java/com/ruoyi/framework/config/MyBatisConfig.java`

---

### æ­¥éª¤4ï¼šæ•°æ®åº“æ”¹é€ 

#### æ‰§è¡ŒSQLè„šæœ¬

```sql
-- 1. åˆ›å»ºç§Ÿæˆ·è¡¨
CREATE TABLE `sys_tenant` ( ... );

-- 2. ä¸ºç°æœ‰è¡¨æ·»åŠ tenant_idå­—æ®µ
ALTER TABLE sys_user ADD COLUMN tenant_id bigint(20) DEFAULT NULL COMMENT 'ç§Ÿæˆ·ID';
ALTER TABLE sys_dept ADD COLUMN tenant_id bigint(20) DEFAULT NULL COMMENT 'ç§Ÿæˆ·ID';
ALTER TABLE sys_role ADD COLUMN tenant_id bigint(20) DEFAULT NULL COMMENT 'ç§Ÿæˆ·ID';
ALTER TABLE sys_post ADD COLUMN tenant_id bigint(20) DEFAULT NULL COMMENT 'ç§Ÿæˆ·ID';
ALTER TABLE sys_notice ADD COLUMN tenant_id bigint(20) DEFAULT NULL COMMENT 'ç§Ÿæˆ·ID';

-- 3. åˆ›å»ºç´¢å¼•
CREATE INDEX idx_tenant_id ON sys_user(tenant_id);
CREATE INDEX idx_tenant_id ON sys_dept(tenant_id);
CREATE INDEX idx_tenant_id ON sys_role(tenant_id);
CREATE INDEX idx_tenant_id ON sys_post(tenant_id);
CREATE INDEX idx_tenant_id ON sys_notice(tenant_id);

-- 4. ç”¨æˆ·è¡¨ç‰¹æ®Šä¼˜åŒ–
CREATE INDEX idx_tenant_user ON sys_user(tenant_id, user_name);

-- 5. åˆå§‹åŒ–é»˜è®¤ç§Ÿæˆ·
INSERT INTO sys_tenant (tenant_id, tenant_name, tenant_code, status, create_time)
VALUES (1, 'é»˜è®¤ç§Ÿæˆ·', 'DEFAULT', '0', NOW());

-- 6. æ›´æ–°ç°æœ‰æ•°æ®å…³è”åˆ°é»˜è®¤ç§Ÿæˆ·
UPDATE sys_user SET tenant_id = 1 WHERE user_id > 1;  -- ä¿ç•™adminä¸ºNULLï¼ˆè¶…çº§ç®¡ç†å‘˜ï¼‰
UPDATE sys_dept SET tenant_id = 1;
UPDATE sys_role SET tenant_id = 1 WHERE role_id > 1;
```

**å®Œæ•´SQLè„šæœ¬**ï¼š`sql/ry_20250522_with_tenant.sql`

---

### æ­¥éª¤5ï¼šé…ç½®ç§Ÿæˆ·è§„åˆ™

åœ¨ `TenantConfig.java` ä¸­é…ç½®ï¼š

#### é…ç½®è¶…çº§ç®¡ç†å‘˜

```java
public static final List<Long> SUPER_ADMIN_USER_IDS = Arrays.asList(
    1L  // adminç”¨æˆ·IDï¼Œæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
);
```

#### é…ç½®å¿½ç•¥URL

```java
public static final List<String> IGNORE_URLS = Arrays.asList(
    "/login",
    "/captchaImage",
    "/logout",
    "/register"
    // æ ¹æ®é¡¹ç›®æ·»åŠ å…¶ä»–å…¬å…±æ¥å£
);
```

#### é…ç½®ç§Ÿæˆ·è¡¨

```java
public static final List<String> TENANT_TABLES = Arrays.asList(
    // è‹¥ä¾æ¡†æ¶è¡¨
    "sys_user",
    "sys_dept",
    "sys_role",
    "sys_post",
    "sys_notice",

    // ä½ çš„ä¸šåŠ¡è¡¨ï¼ˆæ ¹æ®å®é™…æƒ…å†µæ·»åŠ ï¼‰
    "your_business_table1",
    "your_business_table2"
);
```

#### é…ç½®å…¨å±€è¡¨

```java
public static final List<String> IGNORE_TABLES = Arrays.asList(
    "sys_menu",
    "sys_dict_type",
    "sys_dict_data",
    "sys_config",
    "sys_user_role",
    "sys_role_menu",
    "sys_role_dept",
    "sys_tenant",
    "sys_logininfor",
    "sys_oper_log",
    "sys_job",
    "sys_job_log"
    // æ ¹æ®é¡¹ç›®æ·»åŠ å…¶ä»–å…¨å±€è¡¨
);
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šä½¿ç”¨æŒ‡å—

### 4.1 ç§Ÿæˆ·ç®¡ç†API

#### åˆ›å»ºç§Ÿæˆ·

**æ¥å£**ï¼š`POST /link/tenant`

**è¯·æ±‚ä½“**ï¼š
```json
{
  "tenantName": "ç†å‘åº—A",
  "tenantCode": "SHOP_A",
  "contactName": "å¼ ä¸‰",
  "contactPhone": "13800138000",
  "expireTime": "2026-12-31 23:59:59",
  "status": "0"
}
```

**å“åº”**ï¼š
```json
{
  "code": 200,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": {
    "tenantId": 1001
  }
}
```

#### ç”¨æˆ·åˆ†é…ç§Ÿæˆ·

ç¼–è¾‘ç”¨æˆ·æ—¶ï¼Œè®¾ç½® `tenantId` å­—æ®µï¼š

**æ¥å£**ï¼š`PUT /system/user`

**è¯·æ±‚ä½“**ï¼š
```json
{
  "userId": 100,
  "userName": "shop_admin",
  "nickName": "åº—é•¿",
  "tenantId": 1001,  // åˆ†é…åˆ°ç§Ÿæˆ·1001
  ...
}
```

#### ç§Ÿæˆ·çŠ¶æ€ç®¡ç†

**å¯ç”¨ç§Ÿæˆ·**ï¼š
```json
PUT /link/tenant
{
  "tenantId": 1001,
  "status": "0"
}
```

**åœç”¨ç§Ÿæˆ·**ï¼ˆç”¨æˆ·å°†æ— æ³•ç™»å½•ï¼‰ï¼š
```json
PUT /link/tenant
{
  "tenantId": 1001,
  "status": "1"
}
```

---

### 4.2 å¼€å‘æ³¨æ„äº‹é¡¹

#### å“ªäº›è¡¨éœ€è¦æ·»åŠ tenant_idï¼Ÿ

**åˆ¤æ–­æ ‡å‡†**ï¼š
- æ•°æ®æ˜¯å¦å±äºæŸä¸ªç§Ÿæˆ·ï¼ˆå®¢æˆ·ç»„ç»‡ï¼‰ï¼Ÿ
- ä¸åŒç§Ÿæˆ·ä¹‹é—´æ˜¯å¦éœ€è¦éš”ç¦»ï¼Ÿ

**éœ€è¦æ·»åŠ **ï¼š
- ç”¨æˆ·ç›¸å…³è¡¨ï¼š`sys_user`ã€`sys_dept`ã€`sys_role`ã€`sys_post`
- ä¸šåŠ¡æ ¸å¿ƒè¡¨ï¼šè®¢å•ã€å®¢æˆ·ã€äº§å“ã€æœåŠ¡ã€å‘˜å·¥ç­‰
- ä¸šåŠ¡å…³è”è¡¨ï¼šè®¢å•æ˜ç»†ã€å®¢æˆ·æ ‡ç­¾ç­‰

**ä¸éœ€è¦æ·»åŠ **ï¼š
- ç³»ç»Ÿé…ç½®è¡¨ï¼šèœå•ã€å­—å…¸ã€ç³»ç»Ÿå‚æ•°
- æ—¥å¿—è¡¨ï¼šç™»å½•æ—¥å¿—ã€æ“ä½œæ—¥å¿—
- å…³è”è¡¨ï¼š`sys_user_role`ï¼ˆé€šè¿‡user_idé—´æ¥å…³è”ç§Ÿæˆ·ï¼‰
- æšä¸¾è¡¨ï¼šæ€§åˆ«ã€çŠ¶æ€ç­‰å›ºå®šé€‰é¡¹

#### æ–°å¢ä¸šåŠ¡è¡¨è§„èŒƒ

```sql
CREATE TABLE your_business_table (
  id bigint(20) NOT NULL AUTO_INCREMENT,
  tenant_id bigint(20) DEFAULT NULL COMMENT 'ç§Ÿæˆ·ID',  -- å¿…é¡»æ·»åŠ 
  your_field1 varchar(50),
  ...
  PRIMARY KEY (id),
  INDEX idx_tenant_id (tenant_id)  -- å¿…é¡»æ·»åŠ ç´¢å¼•
) COMMENT='ä¸šåŠ¡è¡¨';
```

ç„¶ååœ¨ `TenantConfig.TENANT_TABLES` ä¸­æ³¨å†Œè¡¨åã€‚

#### ç‰¹æ®Šåœºæ™¯å¤„ç†

**åœºæ™¯1ï¼šå®šæ—¶ä»»åŠ¡**

å®šæ—¶ä»»åŠ¡æ— HTTPè¯·æ±‚ï¼Œæ— æ³•è‡ªåŠ¨è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼Œéœ€è¦æ‰‹åŠ¨è®¾ç½®ï¼š

```java
@Scheduled(cron = "0 0 2 * * ?")
public void dailyTask() {
    // éå†æ‰€æœ‰ç§Ÿæˆ·
    List<SysTenant> tenants = tenantService.selectActiveTenants();

    for (SysTenant tenant : tenants) {
        try {
            // è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
            TenantContext.setTenantId(tenant.getTenantId());

            // æ‰§è¡Œç§Ÿæˆ·ç›¸å…³ä»»åŠ¡
            doBusinessLogic();

        } finally {
            // å¿…é¡»æ¸…é™¤
            TenantContext.clear();
        }
    }
}
```

**åœºæ™¯2ï¼šå¼‚æ­¥ä»»åŠ¡**

ä½¿ç”¨ `@Async` æ³¨è§£çš„å¼‚æ­¥ä»»åŠ¡ï¼Œ`TransmittableThreadLocal` ä¼šè‡ªåŠ¨ä¼ é€’ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†ï¼š

```java
@Async
public void asyncTask() {
    // TenantContext.getTenantId() è‡ªåŠ¨è·å–åˆ°ä¸»çº¿ç¨‹çš„ç§Ÿæˆ·ID
    Long tenantId = TenantContext.getTenantId();

    // æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡...
}
```

**åœºæ™¯3ï¼šè·¨ç§Ÿæˆ·æŸ¥è¯¢ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰**

æŸäº›åœºæ™¯éœ€è¦æŸ¥è¯¢å…¶ä»–ç§Ÿæˆ·æ•°æ®ï¼ˆå¦‚æ•°æ®ç»Ÿè®¡ã€è¿ç§»å·¥å…·ï¼‰ï¼š

```java
public void crossTenantQuery() {
    try {
        // ä¸´æ—¶å¼€å¯å…¨å±€æ¨¡å¼
        TenantContext.setIgnore(true);

        // æŸ¥è¯¢æ‰€æœ‰ç§Ÿæˆ·æ•°æ®
        List<SysUser> allUsers = userMapper.selectUserList(new SysUser());

        // å¤„ç†æ•°æ®...

    } finally {
        // å¿…é¡»æ¢å¤ç§Ÿæˆ·è¿‡æ»¤
        TenantContext.setIgnore(false);
    }
}
```

**å®‰å…¨æé†’**ï¼šè·¨ç§Ÿæˆ·æ“ä½œå¿…é¡»ä¸¥æ ¼æ§åˆ¶æƒé™ï¼Œå¹¶è®°å½•å®¡è®¡æ—¥å¿—ï¼

---

### 4.3 æµ‹è¯•éªŒè¯

#### éªŒè¯ç§Ÿæˆ·éš”ç¦»

**æ­¥éª¤1**ï¼šåˆ›å»º2ä¸ªæµ‹è¯•ç§Ÿæˆ·

```sql
INSERT INTO sys_tenant (tenant_name, tenant_code, status, create_time)
VALUES
  ('ç§Ÿæˆ·A', 'TENANT_A', '0', NOW()),
  ('ç§Ÿæˆ·B', 'TENANT_B', '0', NOW());
```

**æ­¥éª¤2**ï¼šåˆ›å»ºå±äºä¸åŒç§Ÿæˆ·çš„ç”¨æˆ·

```sql
-- ç§Ÿæˆ·Açš„ç”¨æˆ·
INSERT INTO sys_user (user_name, nick_name, tenant_id, password, create_time)
VALUES ('user_a', 'ç”¨æˆ·A', 1001, '$2a$...', NOW());

-- ç§Ÿæˆ·Bçš„ç”¨æˆ·
INSERT INTO sys_user (user_name, nick_name, tenant_id, password, create_time)
VALUES ('user_b', 'ç”¨æˆ·B', 1002, '$2a$...', NOW());
```

**æ­¥éª¤3**ï¼šç™»å½•éªŒè¯

- ä½¿ç”¨ `user_a` ç™»å½•ï¼ŒæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨ â†’ åªèƒ½çœ‹åˆ°ç§Ÿæˆ·Açš„ç”¨æˆ·
- ä½¿ç”¨ `user_b` ç™»å½•ï¼ŒæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨ â†’ åªèƒ½çœ‹åˆ°ç§Ÿæˆ·Bçš„ç”¨æˆ·
- ä½¿ç”¨ `admin` ç™»å½•ï¼ˆè¶…çº§ç®¡ç†å‘˜ï¼‰ â†’ å¯ä»¥çœ‹åˆ°æ‰€æœ‰ç”¨æˆ·

#### å¼€å¯SQLæ—¥å¿—

åœ¨ `application.yml` ä¸­é…ç½®ï¼š

```yaml
logging:
  level:
    com.ruoyi.system.mapper: DEBUG  # å¼€å¯MyBatisæ—¥å¿—
```

é‡å¯åï¼Œæ§åˆ¶å°ä¼šè¾“å‡ºæ‰§è¡Œçš„SQLï¼š

```sql
==> Preparing: SELECT * FROM sys_user WHERE tenant_id = ? AND user_name = ?
==> Parameters: 1001(Long), user_a(String)
<== Total: 1
```

éªŒè¯SQLæ˜¯å¦åŒ…å« `tenant_id` è¿‡æ»¤æ¡ä»¶ã€‚

#### å¸¸è§é—®é¢˜æ’æŸ¥

| é—®é¢˜ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ³• |
|---------|---------|---------|
| ç§Ÿæˆ·IDä¸ºç©º | LoginUseræœªè®¾ç½®tenantId | æ£€æŸ¥ç™»å½•æµç¨‹ï¼Œç¡®ä¿æå–å¹¶è®¾ç½®ç§Ÿæˆ·ID |
| SQLæœªæ·»åŠ ç§Ÿæˆ·è¿‡æ»¤ | è¡¨æœªåœ¨TENANT_TABLESä¸­ | åœ¨TenantConfigä¸­æ³¨å†Œè¡¨å |
| çœ‹åˆ°å…¶ä»–ç§Ÿæˆ·æ•°æ® | æ‹¦æˆªå™¨æœªç”Ÿæ•ˆ | æ£€æŸ¥æ‹¦æˆªå™¨æ³¨å†Œé¡ºåº |
| å¼‚æ­¥ä»»åŠ¡ä¸¢å¤±ç§Ÿæˆ·ID | ä½¿ç”¨äº†æ™®é€šThreadLocal | ç¡®è®¤ä½¿ç”¨TransmittableThreadLocal |
| çº¿ç¨‹æ± åœºæ™¯ä¸¢å¤±ä¸Šä¸‹æ–‡ | æœªæ¸…é™¤TenantContext | æ£€æŸ¥afterCompletionæ˜¯å¦æ‰§è¡Œ |

---

## ç¬¬äº”éƒ¨åˆ†ï¼šæœ€ä½³å®è·µä¸å¸¸è§é—®é¢˜

### 5.1 å®‰å…¨å»ºè®®

#### é˜²æ­¢æ•°æ®æ³„éœ²

- **å¼ºåˆ¶è§„èŒƒ**ï¼šæ‰€æœ‰ä¸šåŠ¡è¡¨å¿…é¡»æ·»åŠ  `tenant_id` å­—æ®µå’Œç´¢å¼•
- **ä»£ç å®¡æŸ¥**ï¼šç¦æ­¢ä½¿ç”¨åŸç”ŸJDBCæˆ–ç›´æ¥æ‹¼æ¥SQLï¼ˆç»•è¿‡æ‹¦æˆªå™¨ï¼‰
- **æµ‹è¯•è¦†ç›–**ï¼šç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯ç§Ÿæˆ·éš”ç¦»
- **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•è¶…çº§ç®¡ç†å‘˜çš„å…¨å±€æ¨¡å¼æ“ä½œ

```java
// é”™è¯¯ç¤ºä¾‹ï¼šç»•è¿‡æ‹¦æˆªå™¨
jdbcTemplate.query("SELECT * FROM sys_user", ...);  // âŒ

// æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨MyBatis
userMapper.selectUserList(query);  // âœ…
```

#### å¼‚å¸¸å¤„ç†

```java
// ç§Ÿæˆ·IDç¼ºå¤±æ—¶æ‹’ç»æ‰§è¡Œ
public static Long getRequiredTenantId() {
    Long tenantId = getTenantId();
    if (tenantId == null && !isIgnore()) {
        log.error("ã€å®‰å…¨è­¦å‘Šã€‘ç§Ÿæˆ·ä¸Šä¸‹æ–‡ä¸¢å¤±");
        throw new ServiceException("ç§Ÿæˆ·ä¸Šä¸‹æ–‡ä¸¢å¤±ï¼Œè¯·é‡æ–°ç™»å½•");
    }
    return tenantId;
}
```

#### æ•°æ®å®Œæ•´æ€§æ£€æŸ¥

å®šæœŸæ‰§è¡ŒSQLæ£€æŸ¥æ˜¯å¦æœ‰é—æ¼çš„æ•°æ®ï¼š

```sql
-- æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·æœªåˆ†é…ç§Ÿæˆ·ï¼ˆæ’é™¤è¶…çº§ç®¡ç†å‘˜ï¼‰
SELECT * FROM sys_user WHERE tenant_id IS NULL AND user_id > 1;

-- æ£€æŸ¥æ˜¯å¦æœ‰ç§Ÿæˆ·IDä¸å­˜åœ¨çš„æ•°æ®
SELECT * FROM sys_user u
LEFT JOIN sys_tenant t ON u.tenant_id = t.tenant_id
WHERE u.tenant_id IS NOT NULL AND t.tenant_id IS NULL;
```

---

### 5.2 æ€§èƒ½ä¼˜åŒ–

#### ç´¢å¼•è®¾è®¡

**å•åˆ—ç´¢å¼•**ï¼š
```sql
CREATE INDEX idx_tenant_id ON your_table(tenant_id);
```

**å¤åˆç´¢å¼•**ï¼ˆæ¨èï¼‰ï¼š
```sql
-- å°†tenant_idæ”¾åœ¨ç¬¬ä¸€ä½
CREATE INDEX idx_tenant_xxx ON your_table(tenant_id, frequently_queried_field);

-- ç¤ºä¾‹ï¼šç”¨æˆ·è¡¨ç™»å½•æŸ¥è¯¢
CREATE INDEX idx_tenant_user ON sys_user(tenant_id, user_name);

-- ç¤ºä¾‹ï¼šè®¢å•è¡¨æŒ‰æ—¶é—´æŸ¥è¯¢
CREATE INDEX idx_tenant_time ON hl_order(tenant_id, create_time);
```

**ä¸ºä»€ä¹ˆè¦å¤åˆç´¢å¼•ï¼Ÿ**
- SQLæŸ¥è¯¢ï¼š`WHERE tenant_id = 1001 AND user_name = 'admin'`
- å•åˆ—ç´¢å¼•ï¼šå…ˆç”¨tenant_idç´¢å¼•ï¼Œå†å›è¡¨è¿‡æ»¤user_name
- å¤åˆç´¢å¼•ï¼šç›´æ¥å®šä½åˆ°ç»“æœï¼Œæ— éœ€å›è¡¨

#### å¤§æ•°æ®é‡åœºæ™¯

**åœºæ™¯**ï¼šå•ä¸ªç§Ÿæˆ·æ•°æ®é‡è¶…è¿‡500ä¸‡

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
1. **åˆ†è¡¨ç­–ç•¥**ï¼šæŒ‰ç§Ÿæˆ·IDåˆ†è¡¨ï¼ˆ`hl_order_1001`ã€`hl_order_1002`ï¼‰
2. **å†·çƒ­åˆ†ç¦»**ï¼šå†å²æ•°æ®å½’æ¡£åˆ°å†å²è¡¨
3. **è¯»å†™åˆ†ç¦»**ï¼šç§Ÿæˆ·è¡¨ä½¿ç”¨ç‹¬ç«‹çš„ä»åº“

```java
// åŠ¨æ€è¡¨åç¤ºä¾‹
String tableName = "hl_order_" + tenantId;
orderMapper.selectFromTable(tableName, query);
```

#### ç¼“å­˜ç­–ç•¥

**Redisç¼“å­˜Keyè®¾è®¡**ï¼š

```java
// é”™è¯¯ï¼šæœªåŒ…å«ç§Ÿæˆ·IDï¼Œä¸åŒç§Ÿæˆ·ä¼šå†²çª
String cacheKey = "user:" + userId;  // âŒ

// æ­£ç¡®ï¼šåŒ…å«ç§Ÿæˆ·ID
String cacheKey = "tenant:" + tenantId + ":user:" + userId;  // âœ…

// æˆ–ä½¿ç”¨å‰ç¼€
String cacheKey = "T" + tenantId + ":user:" + userId;  // âœ…
```

**ç¼“å­˜æ¸…é™¤**ï¼š

```java
@CacheEvict(value = "user", key = "'T' + #user.tenantId + ':' + #user.userId")
public void updateUser(SysUser user) {
    userMapper.updateUser(user);
}
```

---

### 5.3 å¸¸è§é—®é¢˜FAQ

#### Q1: TransmittableThreadLocal vs ThreadLocalï¼Ÿ

| ç‰¹æ€§ | ThreadLocal | TransmittableThreadLocal |
|-----|------------|--------------------------|
| çº¿ç¨‹å†…è®¿é—® | âœ… | âœ… |
| çˆ¶å­çº¿ç¨‹ä¼ é€’ | âŒ | âœ… |
| çº¿ç¨‹æ± åœºæ™¯ | âŒ ä¼šä¸¢å¤± | âœ… è‡ªåŠ¨ä¼ é€’ |
| æ€§èƒ½å¼€é”€ | ä½ | ç¨é«˜ï¼ˆå¯æ¥å—ï¼‰ |

**ç»“è®º**ï¼šè‹¥ä¾æ¡†æ¶ä½¿ç”¨äº†å¤§é‡å¼‚æ­¥ä»»åŠ¡å’Œçº¿ç¨‹æ± ï¼Œå¿…é¡»ä½¿ç”¨TransmittableThreadLocalã€‚

#### Q2: ä¸ºä»€ä¹ˆç™»å½•æ—¶è¦ä¸´æ—¶å¼€å¯å…¨å±€æ¨¡å¼ï¼Ÿ

**é—®é¢˜**ï¼šç”¨æˆ·ç™»å½•æ—¶å°šæœªè®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼Œä½†æŸ¥è¯¢ `sys_user` éœ€è¦ç§Ÿæˆ·IDã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šç™»å½•é˜¶æ®µä¸´æ—¶å¼€å¯å…¨å±€æ¨¡å¼ï¼ŒéªŒè¯é€šè¿‡åç«‹å³å…³é—­ã€‚

```java
TenantContext.setIgnore(true);  // å¼€å¯å…¨å±€æ¨¡å¼
try {
    // æŸ¥è¯¢ç”¨æˆ·ã€éªŒè¯å¯†ç ...
} finally {
    TenantContext.clear();  // æ¸…é™¤å…¨å±€æ¨¡å¼
}
```

#### Q3: JOINæŸ¥è¯¢å¦‚ä½•å¤„ç†ï¼Ÿ

**ç­”**ï¼š`TenantSqlInterceptor` ä½¿ç”¨JSQLParserè§£æSQLï¼Œè‡ªåŠ¨è¯†åˆ«JOINä¸­çš„æ¯ä¸ªè¡¨ï¼Œå¹¶ä¸ºç§Ÿæˆ·è¡¨æ·»åŠ è¿‡æ»¤æ¡ä»¶ã€‚

```sql
-- åŸå§‹SQL
SELECT u.*, d.dept_name FROM sys_user u LEFT JOIN sys_dept d ON u.dept_id = d.dept_id

-- è‡ªåŠ¨æ”¹å†™
SELECT u.*, d.dept_name
FROM sys_user u LEFT JOIN sys_dept d ON u.dept_id = d.dept_id
WHERE u.tenant_id = 1001 AND d.tenant_id = 1001
```

**æ³¨æ„**ï¼šç¡®ä¿JOINçš„ä¸¤ä¸ªè¡¨éƒ½æœ‰ `tenant_id` å­—æ®µä¸”éƒ½åœ¨ `TENANT_TABLES` ä¸­ã€‚

#### Q4: å¦‚ä½•æ”¯æŒç§Ÿæˆ·çº§åˆ«çš„é…ç½®ï¼Ÿ

**æ–¹æ¡ˆ1**ï¼šç§Ÿæˆ·é…ç½®è¡¨

```sql
CREATE TABLE sys_tenant_config (
  id bigint(20) PRIMARY KEY,
  tenant_id bigint(20) NOT NULL,
  config_key varchar(50),
  config_value varchar(500),
  INDEX idx_tenant_key (tenant_id, config_key)
);
```

**æ–¹æ¡ˆ2**ï¼šæ‰©å±•ç§Ÿæˆ·è¡¨å­—æ®µ

```sql
ALTER TABLE sys_tenant ADD COLUMN config_json TEXT COMMENT 'ç§Ÿæˆ·é…ç½®JSON';
```

#### Q5: ç§Ÿæˆ·æ•°æ®å¦‚ä½•è¿ç§»å’Œå¤‡ä»½ï¼Ÿ

**å¯¼å‡ºå•ä¸ªç§Ÿæˆ·æ•°æ®**ï¼š

```bash
mysqldump -u root -p your_database \
  --where="tenant_id=1001" \
  sys_user sys_dept sys_role hl_order > tenant_1001_backup.sql
```

**å¯¼å…¥åˆ°æ–°ç§Ÿæˆ·**ï¼š

```sql
-- 1. åˆ›å»ºæ–°ç§Ÿæˆ·
INSERT INTO sys_tenant (...) VALUES (...);  -- è·å¾—æ–°ç§Ÿæˆ·ID 1002

-- 2. å¯¼å…¥æ•°æ®å¹¶æ›¿æ¢ç§Ÿæˆ·ID
-- ä½¿ç”¨è„šæœ¬æ‰¹é‡æ›¿æ¢ tenant_id=1001 ä¸º tenant_id=1002
```

---

## æ€»ç»“

è‹¥ä¾å¤šç§Ÿæˆ·æ¶æ„é‡‡ç”¨ **å…±äº«æ•°æ®åº“+å…±äº«Schema+tenant_idéš”ç¦»** æ¨¡å¼ï¼Œé€šè¿‡ **åŒå±‚æ‹¦æˆªæœºåˆ¶**ï¼ˆWebæ‹¦æˆªå™¨+SQLæ‹¦æˆªå™¨ï¼‰å®ç°è‡ªåŠ¨æ•°æ®éš”ç¦»ï¼Œä¸šåŠ¡ä»£ç æ— éœ€æ„ŸçŸ¥ç§Ÿæˆ·é€»è¾‘ã€‚

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- æˆæœ¬ä½ï¼Œç»´æŠ¤ç®€å•
- é€æ˜åŒ–éš”ç¦»ï¼Œä¸šåŠ¡ä»£ç æ— ä¾µå…¥
- æ€§èƒ½ä¼˜ç§€ï¼Œå•åº“å¯æ”¯æŒæ•°åƒç§Ÿæˆ·
- æ‰©å±•æ€§å¼ºï¼Œæ”¯æŒç§Ÿæˆ·çº§é…ç½®å’Œå®šåˆ¶

**å…³é”®è®¾è®¡**ï¼š
- `TenantContext`ï¼šåŸºäºTransmittableThreadLocalçš„ç§Ÿæˆ·ä¸Šä¸‹æ–‡
- `TenantInterceptor`ï¼šWebå±‚è¯†åˆ«ç§Ÿæˆ·å¹¶è®¾ç½®ä¸Šä¸‹æ–‡
- `TenantSqlInterceptor`ï¼šMyBatiså±‚è‡ªåŠ¨æ”¹å†™SQLæ·»åŠ tenant_idè¿‡æ»¤
- è¶…çº§ç®¡ç†å‘˜æœºåˆ¶ï¼šæ”¯æŒå…¨å±€æ¨¡å¼ç®¡ç†æ‰€æœ‰ç§Ÿæˆ·æ•°æ®

**å®‰å…¨æé†’**ï¼š
- æ‰€æœ‰ä¸šåŠ¡è¡¨å¿…é¡»æ·»åŠ  `tenant_id` å­—æ®µå’Œç´¢å¼•
- é¿å…ä½¿ç”¨åŸç”ŸSQLç»•è¿‡æ‹¦æˆªå™¨
- è¶…çº§ç®¡ç†å‘˜æ“ä½œå¿…é¡»è®°å½•å®¡è®¡æ—¥å¿—
- å®šæœŸæ£€æŸ¥æ•°æ®å®Œæ•´æ€§

**å‚è€ƒèµ„æ–™**ï¼š
- æºç ä½ç½®ï¼š`ruoyi-common`ã€`ruoyi-framework`ã€`ruoyi-system` æ¨¡å—
- SQLè„šæœ¬ï¼š`sql/ry_20250522_with_tenant.sql`
- æäº¤è®°å½•ï¼š`cc618482 feat(tenant): å®ç°å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»åŠŸèƒ½`

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**æœ€åæ›´æ–°**ï¼š2025-12-19
**ç»´æŠ¤è€…**ï¼šHairLinkå¼€å‘å›¢é˜Ÿ
